{% extends "base_dark.html" %}
{% load widget_tweaks %}

{% block title %}{% if object %}Editar{% else %}Novo{% endif %} Cliente - wCaixaDigital{% endblock %}
{% block page_title %}Gestão de Clientes{% endblock %}

{% block content %}
<div class="p-4 w-full space-y-4">
    
    <!-- Breadcrumb -->
    <a href="{% url 'clientes:list' %}" class="inline-flex items-center gap-1.5 text-sm text-slate-500 hover:text-white transition-colors group">
        <span class="material-symbols-outlined text-base group-hover:-translate-x-1 transition-transform">arrow_back</span>
        Voltar para Listagem
    </a>

    <!-- Main Card -->
    <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-xl shadow-sm overflow-hidden">
        
        <!-- Header compact -->
        <div class="px-6 py-4 border-b border-slate-200 dark:border-border-dark flex items-center justify-between bg-slate-50 dark:bg-surface-dark">
            <div class="flex items-center gap-3">
                <div class="size-9 rounded-lg bg-orange-500/10 flex items-center justify-center border border-orange-500/20">
                    <span class="material-symbols-outlined text-orange-500 text-xl">
                        {% if object %}person_edit{% else %}person_add{% endif %}
                    </span>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 dark:text-white leading-tight">
                        {% if object %}Editar Cliente{% else %}Novo Cliente{% endif %}
                    </h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Tomador de serviço</p>
                </div>
            </div>
            {% if object %}
            <span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold border {% if object.ativo %}bg-emerald-500/10 text-emerald-500 border-emerald-500/20{% else %}bg-red-500/10 text-red-500 border-red-500/20{% endif %}">
                {% if object.ativo %}ATIVO{% else %}INATIVO{% endif %}
            </span>
            {% endif %}
        </div>

        <form method="post" id="cliente-form" class="divide-y divide-slate-200 dark:divide-border-dark" novalidate>
            {% csrf_token %}
            
            <!-- Identificação -->
            <div class="px-6 py-5 space-y-5">
                <h3 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-sm">badge</span> Identificação
                </h3>
                
                <div class="grid grid-cols-12 gap-3">
                    <!-- Tipo -->
                    <div class="col-span-12 sm:col-span-3 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Tipo de Pessoa</label>
                        <div class="relative">
                            {% render_field form.tipo_pessoa class="w-full appearance-none bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_tipo_pessoa" %}
                            <span class="material-symbols-outlined absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-base">arrow_drop_down</span>
                        </div>
                    </div>

                    <!-- CPF/CNPJ -->
                    <div class="col-span-12 sm:col-span-4 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400" id="label_cpf_cnpj">CPF/CNPJ</label>
                        {% render_field form.cpf_cnpj class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" placeholder="Apenas números" id="id_cpf_cnpj" %}
                        {% if form.cpf_cnpj.errors %}
                            <p class="text-[11px] text-red-500">{{ form.cpf_cnpj.errors.0 }}</p>
                        {% endif %}
                        <p class="text-[11px] text-red-500 hidden" id="doc_error"></p>
                    </div>

                    <!-- Inscrição Municipal (PJ only) -->
                    <div class="col-span-12 sm:col-span-5 space-y-1" id="wrap_inscricao_municipal">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Inscrição Municipal</label>
                        {% render_field form.inscricao_municipal class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_inscricao_municipal" %}
                    </div>

                    <!-- Razão Social -->
                    <div class="col-span-12 sm:col-span-6 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400" id="label_razao_social">Razão Social / Nome Completo</label>
                        {% render_field form.razao_social class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_razao_social" %}
                    </div>

                    <!-- Nome Fantasia -->
                    <div class="col-span-12 sm:col-span-6 space-y-1" id="wrap_nome_fantasia">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Nome Fantasia</label>
                        {% render_field form.nome_fantasia class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_nome_fantasia" %}
                    </div>
                </div>
            </div>

            <!-- Contato -->
            <div class="px-6 py-5 space-y-5">
                <h3 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-sm">call</span> Contato
                </h3>
                <div class="grid grid-cols-12 gap-3">
                    <div class="col-span-12 sm:col-span-6 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">E-mail</label>
                        {% render_field form.email class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_email" type="email" placeholder="cliente@exemplo.com" %}
                        <p class="text-[11px] text-red-500 hidden" id="email_error">E-mail inválido</p>
                    </div>
                    <div class="col-span-12 sm:col-span-6 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Telefone</label>
                        {% render_field form.telefone class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_telefone" placeholder="(00) 00000-0000" %}
                    </div>
                </div>
            </div>

            <!-- Endereço -->
            <div class="px-6 py-5 space-y-5">
                <h3 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-sm">pin_drop</span> Endereço
                </h3>
                <div class="grid grid-cols-12 gap-3">
                    <!-- CEP + Buscar -->
                    <div class="col-span-6 sm:col-span-3 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">CEP</label>
                        <div class="flex gap-1.5">
                            {% render_field form.cep class="flex-1 min-w-0 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_cep" placeholder="00000-000" %}
                            <button type="button" id="btn-buscar-cep" onclick="buscarCEP()" class="px-2.5 py-1.5 bg-orange-500 hover:bg-orange-600 text-white rounded-md text-xs font-semibold flex items-center gap-1 transition-colors whitespace-nowrap shadow-sm">
                                <span class="material-symbols-outlined text-sm" id="cep-icon">search</span>
                                <span id="cep-btn-text">Buscar</span>
                            </button>
                        </div>
                    </div>
                    <div class="col-span-6 sm:col-span-7 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Logradouro</label>
                        {% render_field form.logradouro class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_logradouro" %}
                    </div>
                    <div class="col-span-4 sm:col-span-2 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Número</label>
                        {% render_field form.numero class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_numero" %}
                    </div>
                    <div class="col-span-8 sm:col-span-3 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Bairro</label>
                        {% render_field form.bairro class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_bairro" %}
                    </div>
                    <div class="col-span-12 sm:col-span-3 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Complemento</label>
                        {% render_field form.complemento class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_complemento" %}
                    </div>
                    <div class="col-span-7 sm:col-span-4 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Cidade</label>
                        {% render_field form.cidade class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" id="id_cidade" %}
                    </div>
                    <div class="col-span-5 sm:col-span-2 space-y-1">
                        <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">UF</label>
                        {% render_field form.uf class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-md px-3 py-1.5 text-sm placeholder-slate-400 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none uppercase" id="id_uf" maxlength="2" %}
                    </div>
                </div>
            </div>

            <!-- Configurações -->
            <div class="px-6 py-5 space-y-5">
                <h3 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-sm">tune</span> Configurações
                </h3>
                <div class="flex flex-wrap gap-6">
                    <label class="flex items-center gap-2.5 cursor-pointer group">
                        <div class="relative">
                            {% render_field form.consentimento_lgpd class="peer sr-only" %}
                            <div class="w-9 h-5 bg-slate-300 dark:bg-slate-700 rounded-full peer-checked:bg-orange-500 transition-colors"></div>
                            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-4"></div>
                        </div>
                        <span class="text-xs font-medium text-slate-600 dark:text-slate-300 group-hover:text-white transition-colors">LGPD Assinado</span>
                    </label>
                    <label class="flex items-center gap-2.5 cursor-pointer group">
                        <div class="relative">
                            {% render_field form.ativo class="peer sr-only" %}
                            <div class="w-9 h-5 bg-slate-300 dark:bg-slate-700 rounded-full peer-checked:bg-emerald-500 transition-colors"></div>
                            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-4"></div>
                        </div>
                        <span class="text-xs font-medium text-slate-600 dark:text-slate-300 group-hover:text-white transition-colors">Ativo</span>
                    </label>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 bg-slate-50 dark:bg-surface-dark flex items-center justify-end gap-3 sticky bottom-0 z-10">
                <a href="{% url 'clientes:list' %}" class="px-5 py-2 text-xs font-bold text-slate-500 hover:text-white transition-colors">
                    Cancelar
                </a>
                <button type="submit" class="inline-flex items-center px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold rounded-lg shadow-lg shadow-orange-500/20 transition-all hover:-translate-y-0.5 gap-1.5">
                    <span class="material-symbols-outlined text-base">save</span>
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal confirmação doc inválido -->
<div id="modal-doc-invalido" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="fecharModalDoc()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm">
        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-2xl overflow-hidden">
            <div class="p-5 space-y-3">
                <div class="flex items-center gap-3">
                    <div class="size-9 rounded-lg bg-amber-500/10 flex items-center justify-center border border-amber-500/20">
                        <span class="material-symbols-outlined text-amber-500 text-xl">warning</span>
                    </div>
                    <h3 class="text-sm font-bold text-slate-800 dark:text-white">Documento Inválido</h3>
                </div>
                <p class="text-xs text-slate-500 dark:text-slate-400" id="modal-doc-msg">O CPF informado é inválido. Deseja salvar mesmo assim?</p>
            </div>
            <div class="flex border-t border-slate-200 dark:border-border-dark">
                <button type="button" onclick="fecharModalDoc()" class="flex-1 px-4 py-2.5 text-xs font-bold text-slate-500 hover:text-white hover:bg-slate-700 transition-colors">
                    Corrigir
                </button>
                <button type="button" onclick="forcarSalvar()" class="flex-1 px-4 py-2.5 text-xs font-bold text-amber-500 hover:text-white hover:bg-amber-600 transition-colors border-l border-slate-200 dark:border-border-dark">
                    Salvar mesmo assim
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div class="flex items-center gap-2 px-4 py-2.5 rounded-lg shadow-2xl border border-slate-700 bg-slate-800 text-white text-xs">
        <span class="material-symbols-outlined text-sm" id="toast-icon">check_circle</span>
        <span id="toast-msg"></span>
    </div>
</div>

<style>
@keyframes field-flash { 0%{box-shadow:0 0 0 3px rgba(249,115,22,.4)} 100%{box-shadow:none} }
.field-flash { animation: field-flash .6s ease-out; }
</style>

<script>
// === Toast ===
function showToast(msg, ok=true) {
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').textContent = msg;
    const icon = document.getElementById('toast-icon');
    icon.textContent = ok ? 'check_circle' : 'error';
    icon.className = 'material-symbols-outlined text-sm ' + (ok ? 'text-green-400' : 'text-red-400');
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 4000);
}

// === CPF/CNPJ Validation ===
function validarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let soma = 0;
    for (let i = 0; i < 9; i++) soma += parseInt(cpf[i]) * (10 - i);
    let d1 = 11 - (soma % 11);
    if (d1 >= 10) d1 = 0;
    if (parseInt(cpf[9]) !== d1) return false;
    soma = 0;
    for (let i = 0; i < 10; i++) soma += parseInt(cpf[i]) * (11 - i);
    let d2 = 11 - (soma % 11);
    if (d2 >= 10) d2 = 0;
    return parseInt(cpf[10]) === d2;
}

function validarCNPJ(cnpj) {
    cnpj = cnpj.replace(/\D/g, '');
    if (cnpj.length !== 14 || /^(\d)\1{13}$/.test(cnpj)) return false;
    const pesos1 = [5,4,3,2,9,8,7,6,5,4,3,2];
    const pesos2 = [6,5,4,3,2,9,8,7,6,5,4,3,2];
    let soma = 0;
    for (let i = 0; i < 12; i++) soma += parseInt(cnpj[i]) * pesos1[i];
    let d1 = soma % 11 < 2 ? 0 : 11 - (soma % 11);
    if (parseInt(cnpj[12]) !== d1) return false;
    soma = 0;
    for (let i = 0; i < 13; i++) soma += parseInt(cnpj[i]) * pesos2[i];
    let d2 = soma % 11 < 2 ? 0 : 11 - (soma % 11);
    return parseInt(cnpj[13]) === d2;
}

// === Masks ===
function maskCPF(el) {
    let v = el.value.replace(/\D/g, '').slice(0, 11);
    if (v.length > 9) v = v.replace(/^(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
    else if (v.length > 6) v = v.replace(/^(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
    else if (v.length > 3) v = v.replace(/^(\d{3})(\d{1,3})/, '$1.$2');
    el.value = v;
}

function maskCNPJ(el) {
    let v = el.value.replace(/\D/g, '').slice(0, 14);
    if (v.length > 12) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{1,2})/, '$1.$2.$3/$4-$5');
    else if (v.length > 8) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{1,4})/, '$1.$2.$3/$4');
    else if (v.length > 5) v = v.replace(/^(\d{2})(\d{3})(\d{1,3})/, '$1.$2.$3');
    else if (v.length > 2) v = v.replace(/^(\d{2})(\d{1,3})/, '$1.$2');
    el.value = v;
}

function maskPhone(el) {
    let v = el.value.replace(/\D/g, '').slice(0, 11);
    if (v.length > 10) v = v.replace(/^(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    else if (v.length > 6) v = v.replace(/^(\d{2})(\d{4})(\d{1,4})/, '($1) $2-$3');
    else if (v.length > 2) v = v.replace(/^(\d{2})(\d{1,5})/, '($1) $2');
    else if (v.length > 0) v = v.replace(/^(\d{1,2})/, '($1');
    el.value = v;
}

function maskCEP(el) {
    let v = el.value.replace(/\D/g, '').slice(0, 8);
    if (v.length > 5) v = v.replace(/^(\d{5})(\d{1,3})/, '$1-$2');
    el.value = v;
}

// === Tipo Pessoa toggle ===
function onTipoPessoaChange() {
    const tipo = document.getElementById('id_tipo_pessoa').value;
    const isPJ = tipo === 'PJ';
    const docInput = document.getElementById('id_cpf_cnpj');
    const label = document.getElementById('label_cpf_cnpj');
    const wrapIM = document.getElementById('wrap_inscricao_municipal');
    const labelRS = document.getElementById('label_razao_social');

    label.textContent = isPJ ? 'CNPJ' : 'CPF';
    docInput.placeholder = isPJ ? '00.000.000/0000-00' : '000.000.000-00';
    labelRS.textContent = isPJ ? 'Razão Social' : 'Nome Completo';

    wrapIM.classList.toggle('hidden', !isPJ);

    // Reset validation state
    docInput.classList.remove('border-red-500', 'border-emerald-500', 'ring-1', 'ring-red-500', 'ring-emerald-500');
    document.getElementById('doc_error').classList.add('hidden');

    if (docInput.value) docInput.dispatchEvent(new Event('input', { bubbles: true }));
}

// === Document validation on blur ===
function validateDocument() {
    const tipo = document.getElementById('id_tipo_pessoa').value;
    const docInput = document.getElementById('id_cpf_cnpj');
    const errorEl = document.getElementById('doc_error');
    const raw = docInput.value.replace(/\D/g, '');

    if (!raw) {
        docInput.classList.remove('border-red-500', 'border-emerald-500', 'ring-1', 'ring-red-500', 'ring-emerald-500');
        errorEl.classList.add('hidden');
        return;
    }

    let valid;
    if (tipo === 'PJ') {
        valid = raw.length === 14 && validarCNPJ(raw);
        errorEl.textContent = valid ? '' : 'CNPJ inválido — verifique os dígitos';
    } else {
        valid = raw.length === 11 && validarCPF(raw);
        errorEl.textContent = valid ? '' : 'CPF inválido — verifique os dígitos';
    }

    docInput.classList.toggle('border-red-500', !valid);
    docInput.classList.toggle('ring-red-500', !valid);
    docInput.classList.toggle('border-emerald-500', valid);
    docInput.classList.toggle('ring-emerald-500', valid);
    docInput.classList.add('ring-1');
    errorEl.classList.toggle('hidden', valid);
}

// === Email validation ===
function validateEmail(el) {
    const errorEl = document.getElementById('email_error');
    const val = el.value.trim();
    if (!val) {
        el.classList.remove('border-red-500', 'border-emerald-500', 'ring-1', 'ring-red-500', 'ring-emerald-500');
        errorEl.classList.add('hidden');
        return;
    }
    const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
    el.classList.toggle('border-red-500', !valid);
    el.classList.toggle('ring-red-500', !valid);
    el.classList.toggle('border-emerald-500', valid);
    el.classList.toggle('ring-emerald-500', valid);
    el.classList.add('ring-1');
    errorEl.classList.toggle('hidden', valid);
}

// === CEP Lookup ===
async function buscarCEP() {
    const cepInput = document.getElementById('id_cep');
    const cep = cepInput.value.replace(/\D/g, '');
    if (cep.length !== 8) {
        showToast('CEP inválido (8 dígitos)', false);
        cepInput.focus();
        return;
    }

    const btn = document.getElementById('btn-buscar-cep');
    const icon = document.getElementById('cep-icon');
    const txt = document.getElementById('cep-btn-text');
    btn.disabled = true;
    icon.textContent = 'sync';
    icon.classList.add('animate-spin');
    txt.textContent = '…';

    try {
        const resp = await fetch(`{% url 'clientes:cep_lookup' %}?cep=${encodeURIComponent(cepInput.value)}`);
        const data = await resp.json();
        if (!resp.ok) { showToast(data.error || 'CEP não encontrado', false); return; }

        const map = { 'id_logradouro':'logradouro', 'id_bairro':'bairro', 'id_cidade':'cidade', 'id_uf':'uf' };
        let filled = 0;
        for (const [elemId, key] of Object.entries(map)) {
            const el = document.getElementById(elemId);
            if (el && data[key]) {
                el.value = data[key];
                el.dispatchEvent(new Event('input', { bubbles: true }));
                el.classList.add('field-flash');
                setTimeout(() => el.classList.remove('field-flash'), 800);
                filled++;
            }
        }
        document.getElementById('id_numero')?.focus();
        showToast(`${filled} campos preenchidos ✓`);
    } catch (e) {
        showToast('Falha na conexão', false);
    } finally {
        btn.disabled = false;
        icon.textContent = 'search';
        icon.classList.remove('animate-spin');
        txt.textContent = 'Buscar';
    }
}

// === Modal doc inválido ===
let _forceSubmit = false;

function fecharModalDoc() {
    document.getElementById('modal-doc-invalido').classList.add('hidden');
    document.getElementById('id_cpf_cnpj').focus();
}

function forcarSalvar() {
    document.getElementById('modal-doc-invalido').classList.add('hidden');
    _forceSubmit = true;
    document.getElementById('cliente-form').requestSubmit();
}

function isDocInvalido() {
    const tipo = document.getElementById('id_tipo_pessoa').value;
    const raw = document.getElementById('id_cpf_cnpj').value.replace(/\D/g, '');
    if (!raw) return false; // empty is allowed
    if (tipo === 'PJ') return raw.length === 14 && !validarCNPJ(raw);
    return raw.length === 11 && !validarCPF(raw);
}

// === Init ===
document.addEventListener('DOMContentLoaded', () => {
    const docInput = document.getElementById('id_cpf_cnpj');
    const tipoSelect = document.getElementById('id_tipo_pessoa');
    const phoneInput = document.getElementById('id_telefone');
    const cepInput = document.getElementById('id_cep');
    const emailInput = document.getElementById('id_email');
    const form = document.getElementById('cliente-form');

    if (docInput) {
        docInput.addEventListener('input', () => {
            const tipo = tipoSelect ? tipoSelect.value : 'PF';
            if (tipo === 'PJ') maskCNPJ(docInput); else maskCPF(docInput);
        });
        docInput.addEventListener('blur', validateDocument);
    }
    if (phoneInput) phoneInput.addEventListener('input', () => maskPhone(phoneInput));
    if (cepInput) cepInput.addEventListener('input', () => maskCEP(cepInput));
    if (emailInput) emailInput.addEventListener('blur', () => validateEmail(emailInput));
    if (tipoSelect) {
        tipoSelect.addEventListener('change', onTipoPessoaChange);
        onTipoPessoaChange();
    }

    // Intercept submit
    if (form) {
        form.addEventListener('submit', (e) => {
            if (_forceSubmit) { _forceSubmit = false; return; } // let it through
            if (isDocInvalido()) {
                e.preventDefault();
                const tipo = tipoSelect.value;
                const label = tipo === 'PJ' ? 'CNPJ' : 'CPF';
                document.getElementById('modal-doc-msg').textContent =
                    `O ${label} informado é inválido. Deseja salvar mesmo assim?`;
                document.getElementById('modal-doc-invalido').classList.remove('hidden');
            }
        });
    }
});
</script>
{% endblock %}
