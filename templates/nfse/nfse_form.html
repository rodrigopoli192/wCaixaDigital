{% extends "base_dark.html" %}

{% block title %}{% if object %}Editar{% else %}Nova{% endif %} NFS-e - wCaixaDigital{% endblock %}
{% block page_title %}{% if object %}Editar NFS-e{% else %}Nova NFS-e{% endif %}{% endblock %}

{% block content %}
<div class="p-6 w-full max-w-5xl mx-auto space-y-6">

    <!-- Header -->
    <div class="flex items-center gap-4">
        <a href="{% url 'nfse:list' %}" class="size-10 rounded-xl bg-slate-800 dark:bg-[#2B2C30] flex items-center justify-center text-orange-500 hover:bg-slate-700 dark:hover:bg-[#3a3b40] transition-colors">
            <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <div class="flex-1">
            <div class="flex items-center gap-3">
                <h3 class="text-2xl font-bold tracking-tight">{% if object %}Editar NFS-e{% else %}Nova NFS-e{% endif %}</h3>
                {% if ambiente %}
                <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase
                    {% if ambiente == 'PRODUCAO' %}bg-danger/10 text-danger border border-danger/20{% else %}bg-warning/10 text-warning border border-warning/20{% endif %}">
                    {{ ambiente }}
                </span>
                {% endif %}
            </div>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Preencha os dados para gerar o RPS</p>
        </div>
    </div>

    <!-- Form -->
    <form method="post" novalidate class="space-y-6">
        {% csrf_token %}

        <!-- Non-field errors -->
        {% if form.non_field_errors %}
        <div class="bg-danger/5 border border-danger/20 rounded-xl p-4 flex items-start gap-3">
            <span class="material-symbols-outlined text-danger mt-0.5">error</span>
            <div>
                {% for error in form.non_field_errors %}
                <p class="text-sm text-danger">{{ error }}</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Tomador do Serviço -->
        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 dark:border-border-dark bg-slate-50 dark:bg-background-dark/50">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary text-lg">person</span>
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">Tomador do Serviço</h4>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2 space-y-1">
                        <label for="id_cliente" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Cliente</label>
                        {{ form.cliente }}
                        {% if form.cliente.errors %}
                        <p class="text-xs text-danger mt-1">{{ form.cliente.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-slate-400 mt-1">
                            <a href="{% url 'clientes:create' %}" class="text-primary hover:underline">+ Cadastrar novo cliente</a>
                        </p>
                    </div>
                    <div class="space-y-1">
                        <label for="id_competencia" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Competência</label>
                        {{ form.competencia }}
                        {% if form.competencia.errors %}
                        <p class="text-xs text-danger mt-1">{{ form.competencia.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Serviço -->
        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 dark:border-border-dark bg-slate-50 dark:bg-background-dark/50">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary text-lg">work</span>
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">Serviço</h4>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label for="id_servico" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Código de Serviço</label>
                        {{ form.servico }}
                        {% if form.servico.errors %}
                        <p class="text-xs text-danger mt-1">{{ form.servico.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="space-y-1">
                        <label for="id_local_prestacao_ibge" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Local de Prestação (IBGE)</label>
                        {{ form.local_prestacao_ibge }}
                        {% if form.local_prestacao_ibge.errors %}
                        <p class="text-xs text-danger mt-1">{{ form.local_prestacao_ibge.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="space-y-1">
                    <label for="id_discriminacao" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Discriminação do Serviço</label>
                    {{ form.discriminacao }}
                    {% if form.discriminacao.errors %}
                    <p class="text-xs text-danger mt-1">{{ form.discriminacao.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-slate-400 mt-1">Descreva detalhadamente os serviços prestados</p>
                </div>
            </div>
        </div>

        <!-- Valores -->
        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 dark:border-border-dark bg-slate-50 dark:bg-background-dark/50">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary text-lg">payments</span>
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">Valores</h4>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="space-y-1">
                        <label for="id_valor_servicos" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Valor dos Serviços</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-sm text-slate-400 font-bold">R$</span>
                            {{ form.valor_servicos }}
                        </div>
                        {% if form.valor_servicos.errors %}
                        <p class="text-xs text-danger mt-1">{{ form.valor_servicos.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="space-y-1">
                        <label for="id_valor_deducoes" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Deduções</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-sm text-slate-400 font-bold">R$</span>
                            {{ form.valor_deducoes }}
                        </div>
                        {% if form.valor_deducoes.errors %}
                        <p class="text-xs text-danger mt-1">{{ form.valor_deducoes.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="space-y-1">
                        <label for="id_aliquota_iss" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Alíquota ISS (%)</label>
                        {{ form.aliquota_iss }}
                        {% if form.aliquota_iss.errors %}
                        <p class="text-xs text-danger mt-1">{{ form.aliquota_iss.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    {{ form.iss_retido }}
                    <label for="id_iss_retido" class="text-sm text-slate-600 dark:text-slate-300 cursor-pointer select-none">ISS Retido na Fonte</label>
                </div>
            </div>
        </div>

        <!-- Retenções Federais -->
        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 dark:border-border-dark bg-slate-50 dark:bg-background-dark/50">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary text-lg">percent</span>
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">Retenções Federais</h4>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="space-y-1">
                        <label for="id_valor_pis" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">PIS</label>
                        {{ form.valor_pis }}
                    </div>
                    <div class="space-y-1">
                        <label for="id_valor_cofins" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">COFINS</label>
                        {{ form.valor_cofins }}
                    </div>
                    <div class="space-y-1">
                        <label for="id_valor_inss" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">INSS</label>
                        {{ form.valor_inss }}
                    </div>
                    <div class="space-y-1">
                        <label for="id_valor_ir" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">IR</label>
                        {{ form.valor_ir }}
                    </div>
                    <div class="space-y-1">
                        <label for="id_valor_csll" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">CSLL</label>
                        {{ form.valor_csll }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between pt-2">
            <a href="{% url 'nfse:list' %}" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-sm font-medium flex items-center gap-1 transition-colors">
                <span class="material-symbols-outlined text-sm">arrow_back</span>
                Cancelar
            </a>
            <div class="flex gap-3">
                <button type="submit" name="acao" value="salvar" class="border border-slate-200 dark:border-border-dark text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-surface-dark rounded-lg px-6 py-2.5 text-sm font-semibold flex items-center gap-2 transition-all">
                    <span class="material-symbols-outlined text-sm">save</span>
                    Salvar Rascunho
                </button>
                <button type="submit" name="acao" value="enviar" class="bg-success hover:bg-emerald-600 text-white rounded-lg px-6 py-2.5 text-sm font-semibold flex items-center gap-2 transition-all shadow-lg shadow-success/20">
                    <span class="material-symbols-outlined text-sm">send</span>
                    Salvar e Enviar
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}
