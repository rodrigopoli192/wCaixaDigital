<!-- Preview table for import results with checkboxes -->
<div class="p-5 space-y-4" x-data="{
    selectedCount: 0,
    toggleAll(checked) {
        const boxes = this.$refs.previewBody.querySelectorAll('input[name=selected_rows]:not(:disabled)');
        boxes.forEach(b => { b.checked = checked; });
        this.selectedCount = checked ? boxes.length : 0;
    },
    updateCount() {
        const boxes = this.$refs.previewBody.querySelectorAll('input[name=selected_rows]:not(:disabled)');
        this.selectedCount = [...boxes].filter(b => b.checked).length;
    }
}">

    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-primary text-xl">preview</span>
            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-200">
                Pré-visualização
            </h3>
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 font-bold">
                {{ preview_rows|length }} registro(s)
            </span>
        </div>
        <label class="flex items-center gap-2 text-xs text-slate-500 cursor-pointer select-none">
            <input type="checkbox" @change="toggleAll($event.target.checked)"
                   class="w-3.5 h-3.5 text-primary rounded focus:ring-primary">
            Selecionar todos
        </label>
    </div>

    <!-- Preview Table -->
    <form method="post"
          hx-post="{% url 'caixa:importar_movimentos' abertura.pk %}"
          hx-target="#import-results"
          hx-swap="innerHTML"
          hx-indicator="#import-selected-spinner">
        {% csrf_token %}
        <input type="hidden" name="action" value="importar">

        <div class="border border-slate-200 dark:border-border-dark rounded-xl overflow-hidden">
            <div class="max-h-[350px] overflow-y-auto custom-scrollbar">
                <table class="w-full text-xs">
                    <thead class="bg-slate-50 dark:bg-background-dark/50 sticky top-0 z-10">
                        <tr class="text-left text-[10px] uppercase tracking-wider text-slate-500">
                            <th class="px-3 py-2.5 w-8"></th>
                            <th class="px-3 py-2.5">Origem</th>
                            <th class="px-3 py-2.5">Protocolo</th>
                            <th class="px-3 py-2.5">Descrição</th>
                            <th class="px-3 py-2.5">Apresentante</th>
                            <th class="px-3 py-2.5 text-right">Valor</th>
                            <th class="px-3 py-2.5 text-right">Emolumento</th>
                            <th class="px-3 py-2.5 text-right">Tx Jud.</th>
                            <th class="px-3 py-2.5 text-center">QTD</th>
                            <th class="px-3 py-2.5 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody x-ref="previewBody" class="divide-y divide-slate-100 dark:divide-border-dark">
                        {% for row in preview_rows %}
                        <tr class="{% if row.meta_duplicado %}opacity-40{% else %}hover:bg-slate-50 dark:hover:bg-background-dark/30{% endif %} transition-colors has-[:checked]:bg-primary/5">
                            <td class="px-3 py-2">
                                {% if row.meta_duplicado %}
                                <input type="checkbox" disabled
                                       class="w-3.5 h-3.5 text-slate-400 rounded cursor-not-allowed">
                                {% else %}
                                <input type="checkbox" name="selected_rows" value="{{ forloop.counter0 }}"
                                       @change="updateCount()"
                                       class="w-3.5 h-3.5 text-primary rounded focus:ring-primary">
                                {% endif %}
                                <!-- Hidden fields per row -->
                                <input type="hidden" name="conexao_id_{{ forloop.counter0 }}" value="{{ row.meta_conexao_id }}">
                                <input type="hidden" name="rotina_id_{{ forloop.counter0 }}" value="{{ row.meta_rotina_id }}">
                                <input type="hidden" name="raw_headers_{{ forloop.counter0 }}" value="{{ row.meta_raw_headers }}">
                                <input type="hidden" name="raw_row_{{ forloop.counter0 }}" value="{{ row.meta_raw_row }}">
                            </td>
                            <td class="px-3 py-2 text-slate-500 dark:text-slate-400 max-w-[140px] truncate text-[10px]" title="{{ row.meta_origem }}">{{ row.meta_origem }}</td>
                            <td class="px-3 py-2 font-mono text-slate-700 dark:text-slate-300">{{ row.protocolo|default:"-" }}</td>
                            <td class="px-3 py-2 text-slate-600 dark:text-slate-400 max-w-[150px] truncate" title="{{ row.descricao|default:'' }}">{{ row.descricao|default:"-" }}</td>
                            <td class="px-3 py-2 text-slate-600 dark:text-slate-400 max-w-[120px] truncate" title="{{ row.cliente_nome|default:'' }}">{{ row.cliente_nome|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-700 dark:text-slate-300">{{ row.valor|default:"0.00" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-700 dark:text-slate-300">{{ row.emolumento|default:"0.00" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-700 dark:text-slate-300">{{ row.taxa_judiciaria|default:"0.00" }}</td>
                            <td class="px-3 py-2 text-center text-slate-600 dark:text-slate-400">{{ row.quantidade|default:"1" }}</td>
                            <td class="px-3 py-2 text-center">
                                {% if row.meta_duplicado %}
                                <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-amber-500/20 text-amber-400 font-bold whitespace-nowrap">Já importado</span>
                                {% else %}
                                <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400 font-bold">Novo</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Import Selected Button -->
        <div class="flex items-center justify-between pt-4">
            <p class="text-xs text-slate-500">
                <span x-text="selectedCount" class="font-bold text-primary">0</span> de {{ preview_rows|length }} selecionado(s)
            </p>
            <button type="submit"
                    :disabled="selectedCount === 0"
                    class="bg-primary hover:bg-orange-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg shadow-primary/30 transition-all flex items-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none">
                <span class="material-symbols-outlined text-lg">cloud_download</span>
                <span class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full hidden" id="import-selected-spinner"></span>
                Importar Selecionados (<span x-text="selectedCount">0</span>)
            </button>
        </div>
    </form>

    {% if logs %}
    <!-- Execution Logs -->
    <details class="group">
        <summary class="text-xs font-bold text-slate-400 uppercase tracking-wider cursor-pointer flex items-center gap-1 hover:text-slate-300 transition-colors">
            <span class="material-symbols-outlined text-sm group-open:rotate-90 transition-transform">chevron_right</span>
            Log de Execução ({{ logs|length }})
        </summary>
        <div class="mt-2 bg-[#1e1e1e] rounded-lg p-3 max-h-[200px] overflow-y-auto custom-scrollbar space-y-0.5">
            {% for log in logs %}
            <p class="text-xs font-mono leading-relaxed {% if log.type == 'success' %}text-emerald-400{% elif log.type == 'error' %}text-red-400{% elif log.type == 'warning' %}text-amber-400{% else %}text-slate-400{% endif %}">
                <span class="text-slate-600">[{{ log.time }}]</span>
                {% if log.type == 'success' %}✓{% elif log.type == 'error' %}✗{% elif log.type == 'warning' %}⚠{% else %}ℹ{% endif %}
                {{ log.msg }}
            </p>
            {% endfor %}
        </div>
    </details>
    {% endif %}
</div>
