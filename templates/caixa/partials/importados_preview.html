<!-- Preview table for import results with checkboxes and detailed view -->
<div class="p-5 space-y-4" x-data="{
    selectedCount: 0,
    showDetailModal: false,
    detailData: {},
    toggleAll(checked) {
        const boxes = this.$refs.previewBody.querySelectorAll('input[name=selected_rows]:not(:disabled)');
        boxes.forEach(b => { b.checked = checked; });
        this.selectedCount = checked ? boxes.length : 0;
    },
    updateCount() {
        const boxes = this.$refs.previewBody.querySelectorAll('input[name=selected_rows]:not(:disabled)');
        this.selectedCount = [...boxes].filter(b => b.checked).length;
    },
    openDetails(data) {
        this.detailData = data;
        this.showDetailModal = true;
    }
}">

    <!-- Detail Modal (Overlay) -->
    <div x-show="showDetailModal" 
         x-transition.opacity 
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4"
         style="display: none;">
        <div @click.outside="showDetailModal = false" 
             class="bg-white dark:bg-[#1e1e1e] rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden border border-slate-200 dark:border-[#2d3544]">
            
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-slate-200 dark:border-[#2d3544] flex items-center justify-between bg-slate-50 dark:bg-[#25262b]">
                <h3 class="font-bold text-lg text-slate-800 dark:text-white">Detalhes do Registro</h3>
                <button @click="showDetailModal = false" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Content (Scrollable) -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-0">
                <table class="w-full text-sm">
                    <tbody class="divide-y divide-slate-100 dark:divide-[#2d3544]">
                        <template x-for="(value, key) in detailData" :key="key">
                            <tr class="hover:bg-slate-50 dark:hover:bg-[#2d3544]/50 transition-colors">
                                <td class="px-6 py-3 font-mono text-slate-500 dark:text-slate-400 w-1/3 text-xs uppercase tracking-wide" x-text="key"></td>
                                <td class="px-6 py-3 font-medium text-slate-800 dark:text-slate-200 break-all" x-text="value"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t border-slate-200 dark:border-[#2d3544] bg-slate-50 dark:bg-[#25262b] flex justify-end">
                <button @click="showDetailModal = false" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-white rounded-lg font-medium transition-colors text-sm">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-primary text-xl">preview</span>
            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-200">
                Pré-visualização
            </h3>
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 font-bold">
                {{ preview_rows|length }} registro(s)
            </span>
        </div>
        <label class="flex items-center gap-2 text-xs text-slate-500 cursor-pointer select-none">
            <input type="checkbox" @change="toggleAll($event.target.checked)"
                   class="w-3.5 h-3.5 text-primary rounded focus:ring-primary">
            Selecionar todos
        </label>
    </div>

    <!-- Preview Table -->
    <form method="post"
          hx-post="{% url 'caixa:importar_movimentos' abertura.pk %}"
          hx-target="#import-results"
          hx-swap="innerHTML"
          hx-indicator="#import-selected-spinner">
        {% csrf_token %}
        <input type="hidden" name="action" value="importar">

        <div class="border border-slate-200 dark:border-border-dark rounded-xl overflow-hidden bg-white dark:bg-[#1e1e1e]">
            <div class="max-h-[450px] overflow-auto custom-scrollbar">
                <table class="w-full text-xs whitespace-nowrap">
                    <thead class="bg-slate-50 dark:bg-[#25262b] sticky top-0 z-10 shadow-sm">
                        <tr class="text-left text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold">
                            <th class="px-3 py-3 w-8 bg-slate-50 dark:bg-[#25262b] sticky left-0 z-20 border-r border-slate-200 dark:border-[#2d3544]"></th>
                            <th class="px-3 py-3 w-10 text-center">Ações</th>
                            <th class="px-3 py-3">Origem</th>
                            <th class="px-3 py-3">Protocolo</th>
                            <th class="px-3 py-3">Descrição</th>
                            <th class="px-3 py-3">Apresentante</th>
                            <th class="px-3 py-3">Data Ato</th>
                            <th class="px-3 py-3 text-right bg-emerald-50/50 dark:bg-emerald-900/10">Valor Total</th>
                            <th class="px-3 py-3 text-right text-blue-600/70 dark:text-blue-400/70">Emolumento</th>
                            <th class="px-3 py-3 text-right text-slate-400">Tx Jud.</th>
                            <th class="px-3 py-3 text-right text-slate-400">ISS</th>
                            <th class="px-3 py-3 text-right text-slate-400">Fundesp</th>
                            <th class="px-3 py-3 text-right text-slate-400">Funesp</th>
                            <th class="px-3 py-3 text-right text-slate-400">Estado</th>
                            <th class="px-3 py-3 text-right text-slate-400">Fesemps</th>
                            <th class="px-3 py-3 text-right text-slate-400">Funemp</th>
                            <th class="px-3 py-3 text-right text-slate-400">Funcomp</th>
                            <th class="px-3 py-3 text-right text-slate-400">Fepadsaj</th>
                            <th class="px-3 py-3 text-right text-slate-400">Funproge</th>
                            <th class="px-3 py-3 text-right text-slate-400">Fundepeg</th>
                            <th class="px-3 py-3 text-right text-slate-400">Fundaf</th>
                            <th class="px-3 py-3 text-right text-slate-400">Femal</th>
                            <th class="px-3 py-3 text-right text-slate-400">Fecad</th>
                            <th class="px-3 py-3 text-right text-slate-400">Rec. Adic. 1</th>
                            <th class="px-3 py-3 text-right text-slate-400">Rec. Adic. 2</th>
                            <th class="px-3 py-3 text-center">QTD</th>
                            <th class="px-3 py-3 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody x-ref="previewBody" class="divide-y divide-slate-100 dark:divide-[#2d3544]">
                        {% for row in preview_rows %}
                        <tr class="{% if row.meta_duplicado %}opacity-50 grayscale{% else %}hover:bg-slate-50 dark:hover:bg-[#2d3544]/40{% endif %} transition-colors has-[:checked]:bg-primary/5 group">
                            <td class="px-3 py-2 bg-white dark:bg-[#1e1e1e] group-hover:bg-slate-50 dark:group-hover:bg-[#2d3544]/40 sticky left-0 z-10 border-r border-slate-100 dark:border-[#2d3544]">
                                {% if row.meta_duplicado %}
                                <input type="checkbox" disabled
                                       class="w-3.5 h-3.5 text-slate-400 rounded cursor-not-allowed bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600">
                                {% else %}
                                <input type="checkbox" name="selected_rows" value="{{ forloop.counter0 }}"
                                       @change="updateCount()"
                                       class="w-3.5 h-3.5 text-primary rounded focus:ring-primary border-slate-300 dark:border-slate-600">
                                {% endif %}
                                <!-- Hidden fields -->
                                <input type="hidden" name="conexao_id_{{ forloop.counter0 }}" value="{{ row.meta_conexao_id }}">
                                <input type="hidden" name="rotina_id_{{ forloop.counter0 }}" value="{{ row.meta_rotina_id }}">
                                <input type="hidden" name="raw_headers_{{ forloop.counter0 }}" value="{{ row.meta_raw_headers }}">
                                <input type="hidden" name="raw_rows_{{ forloop.counter0 }}" value="{{ row.meta_raw_rows }}">
                            </td>
                            <td class="px-3 py-2 text-center">
                                <button type="button" 
                                        @click="openDetails(JSON.parse('{{ row.meta_full_data|escapejs }}'))"
                                        class="p-1 rounded text-slate-400 hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                                        title="Ver todos os campos">
                                    <span class="material-symbols-outlined text-lg">visibility</span>
                                </button>
                            </td>
                            <td class="px-3 py-2 text-slate-500 dark:text-slate-400 max-w-[140px] truncate text-[10px]" title="{{ row.meta_origem }}">{{ row.meta_origem }}</td>
                            <td class="px-3 py-2 font-mono text-slate-700 dark:text-slate-300 font-bold">{{ row.protocolo|default:"-" }}</td>
                            <td class="px-3 py-2 text-slate-600 dark:text-slate-400 max-w-[150px] truncate" title="{{ row.descricao|default:'' }}">{{ row.descricao|default:"-" }}</td>
                            <td class="px-3 py-2 text-slate-600 dark:text-slate-400 max-w-[120px] truncate" title="{{ row.cliente_nome|default:'' }}">{{ row.cliente_nome|default:"-" }}</td>
                            <td class="px-3 py-2 text-slate-600 dark:text-slate-400 text-center">{{ row.data_ato|default:"-" }}</td>
                            
                            <!-- Valores -->
                            <td class="px-3 py-2 text-right font-mono font-bold text-emerald-600 dark:text-emerald-400 bg-emerald-50/30 dark:bg-emerald-900/5">{{ row.valor|default:"0.00" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-blue-600 dark:text-blue-400">{{ row.emolumento|default:"0.00" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-600 dark:text-slate-400">{{ row.taxa_judiciaria|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.iss|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.fundesp|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.funesp|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.estado|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.fesemps|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.funemp|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.funcomp|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.fepadsaj|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.funproge|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.fundepeg|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.fundaf|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.femal|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.fecad|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.valor_receita_adicional_1|default:"-" }}</td>
                            <td class="px-3 py-2 text-right font-mono text-slate-500 dark:text-slate-500">{{ row.valor_receita_adicional_2|default:"-" }}</td>

                            <td class="px-3 py-2 text-center text-slate-600 dark:text-slate-400">{{ row.quantidade|default:"1" }}</td>
                            <td class="px-3 py-2 text-center">
                                {% if row.meta_duplicado %}
                                <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-amber-500/20 text-amber-600 dark:text-amber-400 font-bold whitespace-nowrap border border-amber-200 dark:border-amber-500/20">Já existe</span>
                                {% else %}
                                <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-emerald-500/20 text-emerald-600 dark:text-emerald-400 font-bold border border-emerald-200 dark:border-emerald-500/20">Novo</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Import Selected Button -->
        <div class="flex items-center justify-between pt-4 border-t border-slate-200 dark:border-[#2d3544] mt-4">
            <p class="text-xs text-slate-500 dark:text-slate-400">
                <span x-text="selectedCount" class="font-bold text-primary">0</span> de {{ preview_rows|length }} selecionado(s)
            </p>
            <div class="flex gap-2">
                <button type="button" 
                        @click="document.getElementById('modal-container').innerHTML = ''"
                        class="px-4 py-2 rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 font-medium transition-colors text-sm">
                    Cancelar
                </button>
                <button type="submit"
                        :disabled="selectedCount === 0"
                        class="bg-primary hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-primary/30 transition-all flex items-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none text-sm">
                    <span class="material-symbols-outlined text-lg">cloud_download</span>
                    <span class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full hidden" id="import-selected-spinner"></span>
                    Importar Selecionados (<span x-text="selectedCount">0</span>)
                </button>
            </div>
        </div>
    </form>

    {% if logs %}
    <!-- Execution Logs -->
    <details class="group border border-slate-200 dark:border-[#2d3544] rounded-lg">
        <summary class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider cursor-pointer flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-[#25262b] transition-colors p-3 rounded-lg select-none">
            <span class="material-symbols-outlined text-lg group-open:rotate-90 transition-transform text-slate-400">chevron_right</span>
            Log de Execução ({{ logs|length }})
        </summary>
        <div class="bg-slate-50 dark:bg-[#1e1e1e] border-t border-slate-200 dark:border-[#2d3544] p-3 max-h-[150px] overflow-y-auto custom-scrollbar space-y-0.5">
            {% for log in logs %}
            <p class="text-xs font-mono leading-relaxed {% if log.type == 'success' %}text-emerald-600 dark:text-emerald-400{% elif log.type == 'error' %}text-red-600 dark:text-red-400{% elif log.type == 'warning' %}text-amber-600 dark:text-amber-400{% else %}text-slate-500 dark:text-slate-400{% endif %}">
                <span class="opacity-60">[{{ log.time }}]</span>
                {% if log.type == 'success' %}✓{% elif log.type == 'error' %}✗{% elif log.type == 'warning' %}⚠{% else %}ℹ{% endif %}
                {{ log.msg }}
            </p>
            {% endfor %}
        </div>
    </details>
    {% endif %}
</div>
