{% load widget_tweaks %}

<div id="novo-movimento-container" class="bg-[#101622] text-slate-200 w-full max-w-2xl rounded-xl shadow-2xl border border-[#2d3544] overflow-hidden">
    <!-- Header -->
    <div class="flex justify-between items-center px-6 py-5 border-b border-white/5">
        <h3 class="text-lg font-bold text-white tracking-tight">Novo Movimento</h3>
        <button type="button" @click="open = false" class="text-slate-500 hover:text-white transition-colors">
            <span class="material-symbols-outlined text-xl">close</span>
        </button>
    </div>

    <form hx-post="{% url 'caixa:novo_movimento' abertura.pk %}" hx-target="#modal-content" hx-swap="innerHTML">
        {% csrf_token %}
        
        <div class="p-6 space-y-6">
            {% if form.non_field_errors %}
            <div class="p-4 text-sm text-red-500 bg-red-500/10 border border-red-500/20 rounded-lg">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <!-- Grid Tipo e Forma -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tipo -->
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-400 ml-1">Tipo de Movimento</label>
                    <div class="relative">
                        {% render_field form.tipo class="w-full appearance-none bg-[#202024] border border-white/10 rounded-lg px-4 py-3 text-sm text-white placeholder-slate-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" %}
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none text-xl">arrow_drop_down</span>
                    </div>
                </div>

                <!-- Forma -->
                <div class="space-y-1.5">
                     <label class="text-xs font-bold text-slate-400 ml-1">Forma de Pagamento</label>
                    <div class="relative">
                        {% render_field form.forma_pagamento class="w-full appearance-none bg-[#202024] border border-white/10 rounded-lg px-4 py-3 text-sm text-white placeholder-slate-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" %}
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none text-xl">arrow_drop_down</span>
                    </div>
                </div>
            </div>

            <!-- Valor -->
            <div class="space-y-1.5">
                <label class="text-xs font-bold text-slate-400 ml-1">Valor</label>
                <div class="relative group">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold group-focus-within:text-white transition-colors">R$</span>
                    {% render_field form.valor class="w-full bg-[#202024] border border-white/10 rounded-lg pl-10 pr-4 py-3 text-lg font-bold text-white placeholder-slate-600 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" placeholder="0,00" %}
                </div>
            </div>

             <!-- Descrição -->
             <div class="space-y-1.5">
                <label class="text-xs font-bold text-slate-400 ml-1">Descrição</label>
                {% render_field form.descricao class="w-full bg-[#202024] border border-white/10 rounded-lg px-4 py-3 text-sm text-white placeholder-slate-600 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none resize-none" rows="2" placeholder="Ex: Venda de produtos eletrônicos..." %}
            </div>

            <!-- Cliente -->
            <div class="space-y-1.5">
                <div class="flex justify-between items-center px-1">
                    <label class="text-xs font-bold text-slate-400">Cliente (Tomador)</label>
                    <span class="text-[10px] bg-orange-500/20 text-orange-500 px-2 py-0.5 rounded font-bold uppercase tracking-wider">Obrigatório para NFS-e</span>
                </div>
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        {% render_field form.cliente class="w-full appearance-none bg-[#202024] border border-white/10 rounded-lg pl-4 pr-10 py-3 text-sm text-white placeholder-slate-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" %}
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none text-lg">search</span>
                    </div>
                    <button type="button" hx-get="{% url 'clientes:create' %}" hx-target="#modal-stack" hx-swap="innerHTML" class="flex items-center justify-center px-4 bg-[#202024] border border-slate-700/50 rounded-lg hover:bg-slate-700 hover:border-slate-600 transition-all text-slate-400 hover:text-orange-500 group" title="Cadastrar Novo Cliente">
                        <span class="material-symbols-outlined text-xl group-hover:scale-110 transition-transform">person_add</span>
                    </button>
                </div>
                <p class="text-[11px] text-slate-500 px-1 italic">Vincular a um tomador de serviço para fins de compliance fiscal.</p>
            </div>

            <!-- NFS-e Toggle -->
            <div class="flex items-center justify-between p-4 rounded-xl bg-[#202024] border border-white/5" x-data="{ checked: false }">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-lg bg-orange-500/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-orange-500">receipt_long</span>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-white">Emitir NFS-e automaticamente</p>
                        <p class="text-xs text-slate-500">Gera a nota fiscal eletrônica após o registro</p>
                    </div>
                </div>
                
                <!-- Toggle Switch -->
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="{{ form.emitir_nfse.name }}" class="sr-only peer" x-model="checked" {% if form.emitir_nfse.value %}checked{% endif %}>
                    <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                </label>
            </div>

        </div>

        <!-- Footer -->
        <div class="px-6 py-5 border-t border-[#2d3544] bg-[#101622] flex justify-end gap-3 rounded-b-lg">
             <button type="button" @click="open = false" class="px-4 py-2 text-sm font-medium text-slate-400 hover:text-white transition-colors">
                Cancelar
            </button>
            <button type="submit" class="inline-flex justify-center items-center px-6 py-2.5 bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold rounded-lg shadow-lg shadow-orange-500/20 transition-all">
               <span class="material-symbols-outlined text-lg mr-2">check_circle</span>
               Registrar Movimento
            </button>
        </div>
    </form>
</div>

<div id="modal-stack"></div>

<script>
    document.body.addEventListener("clientCreated", function(evt){
        const data = evt.detail; // {id: "...", label: "..."}
        if(!data) return;

        const select = document.getElementById("id_cliente");
        
        if(select) {
            const option = new Option(data.label, data.id, true, true);
            select.add(option);
            select.dispatchEvent(new Event('change'));
        }
        
        const modalStack = document.getElementById('modal-stack');
        if(modalStack) modalStack.innerHTML = ''; 
    });
</script>
