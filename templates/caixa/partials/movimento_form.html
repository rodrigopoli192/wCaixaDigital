{% load widget_tweaks %}

<div id="novo-movimento-container" class="bg-white dark:bg-[#212224] text-slate-900 dark:text-slate-200 w-full max-w-4xl rounded-xl shadow-2xl border border-slate-200 dark:border-[#2d3544] overflow-hidden">
    <!-- Header -->
    <div class="flex justify-between items-center px-6 py-5 border-b border-slate-100 dark:border-white/5">
        <h3 class="text-lg font-bold text-slate-900 dark:text-white tracking-tight">Novo Movimento</h3>
        <button type="button" @click="open = false" class="text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-white transition-colors">
            <span class="material-symbols-outlined text-xl">close</span>
        </button>
    </div>

    <form hx-post="{% url 'caixa:novo_movimento' abertura.pk %}" hx-target="#modal-content" hx-swap="innerHTML">
        {% csrf_token %}
        
        <div class="p-6 space-y-6 max-h-[75vh] overflow-y-auto">
            {% if form.non_field_errors %}
            <div class="p-4 text-sm text-red-500 bg-red-500/10 border border-red-500/20 rounded-lg">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <!-- Grid Tipo e Forma -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tipo -->
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">Tipo de Movimento</label>
                    <div class="relative">
                        {% render_field form.tipo class="w-full appearance-none bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" %}
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none text-xl">arrow_drop_down</span>
                    </div>
                </div>

                <!-- Forma -->
                <div class="space-y-1.5">
                     <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">Forma de Pagamento</label>
                    <div class="relative">
                        {% render_field form.forma_pagamento class="w-full appearance-none bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" %}
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none text-xl">arrow_drop_down</span>
                    </div>
                </div>
            </div>

            <!-- Valor -->
            <div class="space-y-1.5">
                <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">Valor</label>
                <div class="relative group">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold group-focus-within:text-slate-900 dark:group-focus-within:text-white transition-colors">R$</span>
                    {% render_field form.valor class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-10 pr-4 py-3 text-lg font-bold text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-600 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" placeholder="0,00" %}
                </div>
                {% if form.valor.errors %}
                <p class="text-xs text-red-500 mt-1">{{ form.valor.errors|join:", " }}</p>
                {% endif %}
            </div>

             <!-- Descrição -->
             <div class="space-y-1.5">
                <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">Descrição</label>
                {% render_field form.descricao class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-600 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none resize-none" rows="2" placeholder="Ex: Venda de produtos eletrônicos..." %}
            </div>

            <!-- Cliente -->
            <div class="space-y-1.5">
                <div class="flex justify-between items-center px-1">
                    <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Cliente (Tomador)</label>
                    <span class="text-[10px] bg-orange-500/10 dark:bg-orange-500/20 text-orange-600 dark:text-orange-500 px-2 py-0.5 rounded font-bold uppercase tracking-wider">Obrigatório para NFS-e</span>
                </div>
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        {% render_field form.cliente class="w-full appearance-none bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-4 pr-10 py-3 text-sm text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" %}
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none text-lg">search</span>
                    </div>
                    <button type="button" hx-get="{% url 'clientes:create' %}" hx-target="#modal-stack" hx-swap="innerHTML" class="flex items-center justify-center px-4 bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-slate-700/50 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 hover:border-slate-300 dark:hover:border-slate-600 transition-all text-slate-400 hover:text-orange-500 group" title="Cadastrar Novo Cliente">
                        <span class="material-symbols-outlined text-xl group-hover:scale-110 transition-transform">person_add</span>
                    </button>
                </div>
                <p class="text-[11px] text-slate-500 px-1 italic">Vincular a um tomador de serviço para fins de compliance fiscal.</p>
            </div>

            <!-- ==================== DADOS DO ATO / CERTIDÃO ==================== -->
            <div x-data="{ showAto: false }" class="border border-slate-200 dark:border-[#2d3544] rounded-xl overflow-hidden">
                <!-- Toggle Header -->
                <button type="button" @click="showAto = !showAto" class="w-full flex items-center justify-between px-5 py-4 bg-slate-50 dark:bg-[#1a1b1e] hover:bg-slate-100 dark:hover:bg-[#202024] transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="size-8 rounded-lg bg-blue-500/10 flex items-center justify-center">
                            <span class="material-symbols-outlined text-blue-500 text-sm">description</span>
                        </div>
                        <span class="text-sm font-bold text-slate-700 dark:text-slate-300">Dados do Ato / Certidão</span>
                    </div>
                    <span class="material-symbols-outlined text-slate-400 transition-transform duration-200" :class="showAto ? 'rotate-180' : ''">expand_more</span>
                </button>

                <!-- Collapsible Content -->
                <div x-show="showAto" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" class="p-5 space-y-5 border-t border-slate-200 dark:border-[#2d3544]">
                    
                    <!-- Protocolo, Status, Quantidade -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">Protocolo</label>
                            {% render_field form.protocolo class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg px-4 py-2.5 text-sm text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" placeholder="Ex: 2.968" %}
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">Status</label>
                            {% render_field form.status_item class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg px-4 py-2.5 text-sm text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" placeholder="Ex: Aberto" %}
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">Quantidade</label>
                            {% render_field form.quantidade class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg px-4 py-2.5 text-sm text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none" placeholder="1" type="number" min="1" %}
                        </div>
                    </div>

                    <!-- Emolumento + Taxa Judiciária (destaque) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">Emolumento</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">R$</span>
                                {% render_field form.emolumento class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-9 pr-4 py-2.5 text-sm text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">Taxa Judiciária</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">R$</span>
                                {% render_field form.taxa_judiciaria class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-9 pr-4 py-2.5 text-sm text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                    </div>

                    <!-- Separator -->
                    <div class="flex items-center gap-3 py-1">
                        <div class="h-px flex-1 bg-slate-200 dark:bg-[#2d3544]"></div>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Taxas Detalhadas</span>
                        <div class="h-px flex-1 bg-slate-200 dark:bg-[#2d3544]"></div>
                    </div>

                    <!-- Taxas Grid (4 columns) - Row 1 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">ISS</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.iss class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FUNDESP</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.fundesp class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FUNESP</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.funesp class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">ESTADO</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.estado class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FESEMPS</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.fesemps class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FUNEMP</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.funemp class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FUNCOMP</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.funcomp class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FEPADSAJ</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.fepadsaj class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FUNPROGE</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.funproge class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FUNDEPEG</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.fundepeg class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FUNDAF</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.fundaf class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FEMAL</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.femal class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                    </div>

                    <!-- Row 4 (last tax) -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 ml-1 uppercase">FECAD</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold">R$</span>
                                {% render_field form.fecad class="w-full bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/10 rounded-lg pl-7 pr-2 py-2 text-xs text-slate-900 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all outline-none taxa-input" placeholder="0,00" %}
                            </div>
                        </div>
                    </div>

                    <!-- Valor Total Taxas (auto-calculado, read-only) -->
                    <div class="flex items-center justify-end gap-3 pt-3 border-t border-dashed border-slate-200 dark:border-[#2d3544]">
                        <span class="text-xs font-bold text-slate-500 uppercase">Valor Total Taxas:</span>
                        <span id="valor-total-taxas" class="text-lg font-bold text-orange-500">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <!-- NFS-e Toggle -->
            <div class="flex items-center justify-between p-4 rounded-xl bg-slate-50 dark:bg-[#202024] border border-slate-200 dark:border-white/5" x-data="{ checked: false }">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-lg bg-orange-100 dark:bg-orange-500/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-orange-600 dark:text-orange-500">receipt_long</span>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-slate-900 dark:text-white">Emitir NFS-e automaticamente</p>
                        <p class="text-xs text-slate-500">Gera a nota fiscal eletrônica após o registro</p>
                    </div>
                </div>
                
                <!-- Toggle Switch -->
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="{{ form.emitir_nfse.name }}" class="sr-only peer" x-model="checked" {% if form.emitir_nfse.value %}checked{% endif %}>
                    <div class="w-11 h-6 bg-slate-200 dark:bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                </label>
            </div>

        </div>

        <!-- Footer -->
        <div class="px-6 py-5 border-t border-slate-200 dark:border-[#2d3544] bg-slate-50 dark:bg-[#212224] flex justify-end gap-3 rounded-b-lg">
             <button type="button" @click="open = false" class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors">
                Cancelar
            </button>
            <button type="submit" class="inline-flex justify-center items-center px-6 py-2.5 bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold rounded-lg shadow-lg shadow-orange-500/20 transition-all">
               <span class="material-symbols-outlined text-lg mr-2">check_circle</span>
               Registrar Movimento
            </button>
        </div>
    </form>
</div>

<div id="modal-stack"></div>

<script>
    // Máscara de moeda brasileira para o campo valor principal
    (function() {
        const valorInput = document.getElementById('id_valor');
        if (!valorInput) return;
        
        function formatCurrency(value) {
            let numStr = String(value).replace(/\D/g, '');
            if (!numStr) return '0,00';
            if (numStr.length > 12) numStr = numStr.slice(0, 12);
            let num = parseInt(numStr, 10) / 100;
            return num.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        if (!valorInput.value || valorInput.value === '0' || valorInput.value.trim() === '') {
            valorInput.value = '0,00';
        }
        
        valorInput.addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            const oldLength = e.target.value.length;
            e.target.value = formatCurrency(e.target.value);
            const newLength = e.target.value.length;
            const diff = newLength - oldLength;
            const newPos = Math.max(0, cursorPos + diff);
            e.target.setSelectionRange(newPos, newPos);
        });
        
        valorInput.addEventListener('focus', function() {
            this.select();
        });
    })();

    // Máscara de moeda para campos de taxa + cálculo de total
    (function() {
        function formatTaxa(value) {
            let numStr = String(value).replace(/\D/g, '');
            if (!numStr) return '0,00';
            if (numStr.length > 12) numStr = numStr.slice(0, 12);
            let num = parseInt(numStr, 10) / 100;
            return num.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function parseBRL(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
        }

        function updateTotal() {
            const inputs = document.querySelectorAll('.taxa-input');
            let total = 0;
            inputs.forEach(function(inp) {
                total += parseBRL(inp.value);
            });
            const el = document.getElementById('valor-total-taxas');
            if (el) {
                el.textContent = 'R$ ' + total.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }

        document.querySelectorAll('.taxa-input').forEach(function(input) {
            // Format existing values from server (e.g. "0.00" -> "0,00")
            if (!input.value || input.value.trim() === '' || input.value === '0.00' || input.value === '0') {
                input.value = '0,00';
            } else {
                let num = parseFloat(String(input.value).replace(',', '.'));
                if (!isNaN(num)) {
                    input.value = num.toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
            }

            input.addEventListener('input', function(e) {
                const cursorPos = e.target.selectionStart;
                const oldLength = e.target.value.length;
                e.target.value = formatTaxa(e.target.value);
                const newLength = e.target.value.length;
                const diff = newLength - oldLength;
                e.target.setSelectionRange(Math.max(0, cursorPos + diff), Math.max(0, cursorPos + diff));
                updateTotal();
            });

            input.addEventListener('focus', function() {
                this.select();
            });
        });

        updateTotal();
    })();

    // Client creation event listener
    document.body.addEventListener("clientCreated", function(evt){
        const data = evt.detail;
        if(!data) return;

        const select = document.getElementById("id_cliente");
        
        if(select) {
            const option = new Option(data.label, data.id, true, true);
            select.add(option);
            select.dispatchEvent(new Event('change'));
        }
        
        const modalStack = document.getElementById('modal-stack');
        if(modalStack) modalStack.innerHTML = ''; 
    });
</script>
