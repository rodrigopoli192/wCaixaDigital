<!-- Import Movements Modal Form -->
<script type="application/json" id="rotina-var-map">{{ rotina_variaveis|safe }}</script>
<div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-2xl w-full max-w-5xl animate-scale-in"
     style="max-height:90vh; overflow-y:auto;"
     x-data="{ 
        selectedPairs: [],
        rotinaVarMap: {},
        paramValues: {},
        isLoading: false,
        init() {
            // Load rotina variable map from script tag
            try {
                this.rotinaVarMap = JSON.parse(document.getElementById('rotina-var-map').textContent || '{}');
            } catch(e) { this.rotinaVarMap = {}; }
            // Load saved param values
            try {
                const saved = JSON.parse(localStorage.getItem('import_params') || '{}');
                this.paramValues = saved;
            } catch(e) { this.paramValues = {}; }
        },
        toggleConexao(conId, rotinaIds, checked) {
            if (checked) {
                rotinaIds.forEach(rId => {
                    const pair = conId + ':' + rId;
                    if (!this.selectedPairs.includes(pair)) this.selectedPairs.push(pair);
                });
            } else {
                this.selectedPairs = this.selectedPairs.filter(p => !p.startsWith(conId + ':'));
            }
        },
        toggleRotina(conId, rId, checked) {
            const pair = conId + ':' + rId;
            if (checked) {
                if (!this.selectedPairs.includes(pair)) this.selectedPairs.push(pair);
            } else {
                this.selectedPairs = this.selectedPairs.filter(p => p !== pair);
            }
        },
        isConexaoChecked(conId, rotinaIds) {
            return rotinaIds.every(rId => this.selectedPairs.includes(conId + ':' + rId));
        },
        isConexaoPartial(conId, rotinaIds) {
            const some = rotinaIds.some(rId => this.selectedPairs.includes(conId + ':' + rId));
            return some && !this.isConexaoChecked(conId, rotinaIds);
        },
        isRotinaChecked(conId, rId) {
            return this.selectedPairs.includes(conId + ':' + rId);
        },
        get activeVars() {
            const vars = new Set();
            this.selectedPairs.forEach(pair => {
                const rotinaId = pair.split(':')[1];
                (this.rotinaVarMap[rotinaId] || []).forEach(v => vars.add(v));
            });
            return [...vars].sort((a, b) => {
                const au = a.toUpperCase();
                const bu = b.toUpperCase();
                const aIsInicio = au.includes('INICIO') || au.includes('INITIAL');
                const bIsInicio = bu.includes('INICIO') || bu.includes('INITIAL');
                if (aIsInicio && !bIsInicio) return -1;
                if (!aIsInicio && bIsInicio) return 1;
                return a.localeCompare(b);
            });
        },
        isDateVar(name) {
            const n = name.toUpperCase();
            return n.includes('DATA') || n.includes('DATE');
        },
        salvarParams() {
            localStorage.setItem('import_params', JSON.stringify(this.paramValues));
        }
     }">
    
    <!-- Header -->
    <div class="px-6 py-4 border-b border-slate-200 dark:border-border-dark bg-slate-50 dark:bg-background-dark flex items-center justify-between"
         style="position:sticky; top:0; z-index:30;">
        <div>
            <h2 class="text-lg font-bold flex items-center gap-2 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined text-primary">cloud_download</span>
                Importar Movimentos
            </h2>
            <p class="text-xs text-slate-500 text-left">Buscar dados de sistemas externos via rotinas SQL</p>
        </div>
        <button type="button" @click="open = false" class="text-slate-400 hover:text-slate-600 dark:hover:text-white p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
            <span class="material-symbols-outlined">close</span>
        </button>
    </div>

    <!-- Form -->
    <form method="post"
          hx-post="{% url 'caixa:importar_movimentos' abertura.pk %}"
          hx-target="#import-results"
          hx-swap="innerHTML"
          @htmx:before-request.camel="isLoading = true"
          @htmx:after-request.camel="isLoading = false"
          @submit="salvarParams()"
          class="p-6 space-y-5">
        {% csrf_token %}

        <!-- Hidden inputs com os pares selecionados -->
        <template x-for="pair in selectedPairs" :key="pair">
            <input type="hidden" name="conexao_rotina_pairs" :value="pair">
        </template>

        <!-- Conexões + Rotinas (Compact) -->
        <div class="space-y-1.5">
            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Conexões e Rotinas</label>
            
            {% if conexoes_tree %}
            <div class="space-y-2 pr-1" style="max-height:200px; overflow-y:auto;">
                {% for item in conexoes_tree %}
                <div class="rounded-lg border border-slate-200 dark:border-border-dark overflow-hidden">
                    <!-- Conexão header (compact) -->
                    <label class="flex items-center gap-2 px-3 py-1.5 bg-slate-50 dark:bg-background-dark cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <input type="checkbox"
                               @change="toggleConexao('{{ item.conexao.pk }}', [{% for r in item.rotinas %}'{{ r.pk }}'{% if not forloop.last %},{% endif %}{% endfor %}], $event.target.checked)"
                               :checked="isConexaoChecked('{{ item.conexao.pk }}', [{% for r in item.rotinas %}'{{ r.pk }}'{% if not forloop.last %},{% endif %}{% endfor %}])"
                               :indeterminate="isConexaoPartial('{{ item.conexao.pk }}', [{% for r in item.rotinas %}'{{ r.pk }}'{% if not forloop.last %},{% endif %}{% endfor %}])"
                               class="w-3.5 h-3.5 text-primary rounded focus:ring-primary shrink-0">
                        <span class="text-sm font-bold text-primary">{{ item.conexao.sistema }}</span>
                        <span class="text-xs text-slate-400 ml-auto">{{ item.rotinas|length }} rotina(s)</span>
                    </label>
                    <!-- Rotinas (inline chips) -->
                    <div class="flex flex-wrap gap-1.5 px-3 py-2 bg-white dark:bg-surface-dark">
                        {% for rotina in item.rotinas %}
                        <label class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md border border-slate-200 dark:border-border-dark cursor-pointer hover:border-primary/50 hover:bg-primary/5 transition-all has-[:checked]:bg-primary/10 has-[:checked]:border-primary/30 has-[:checked]:text-primary select-none">
                            <input type="checkbox"
                                   @change="toggleRotina('{{ item.conexao.pk }}', '{{ rotina.pk }}', $event.target.checked)"
                                   :checked="isRotinaChecked('{{ item.conexao.pk }}', '{{ rotina.pk }}')"
                                   class="w-3 h-3 text-primary rounded focus:ring-primary">
                            <span class="text-xs text-slate-600 dark:text-slate-300">{{ rotina.nome }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-slate-500 py-2">Nenhuma conexão externa configurada.</p>
            {% endif %}
        </div>

        <!-- Dynamic Parameters (auto-detected from SQL) -->
        <template x-if="activeVars.length > 0">
            <div class="space-y-3">
                <label class="text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm text-primary">tune</span>
                    Parâmetros da Rotina
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <template x-for="varName in activeVars" :key="varName">
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide" x-text="varName.replace(/_/g, ' ')"></label>
                            <template x-if="isDateVar(varName)">
                                <input :type="'date'" 
                                       :name="'param_' + varName" 
                                       x-model="paramValues[varName]"
                                       class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary text-slate-900 dark:text-white transition-all outline-none text-sm">
                            </template>
                            <template x-if="!isDateVar(varName)">
                                <input type="text" 
                                       :name="'param_' + varName" 
                                       x-model="paramValues[varName]"
                                       :placeholder="'@' + varName"
                                       class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary text-slate-900 dark:text-white transition-all outline-none text-sm">
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Actions -->
        <div class="flex items-center justify-between pt-4 border-t border-slate-200 dark:border-border-dark">
            <span class="text-xs text-slate-500" x-show="selectedPairs.length > 0" x-text="selectedPairs.length + ' rotina(s) selecionada(s)'"></span>
            <span x-show="selectedPairs.length === 0"></span>
            <div class="flex items-center gap-3">
                <button type="button" @click="open = false" class="px-5 py-2.5 rounded-lg border border-slate-200 dark:border-border-dark text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-50 dark:hover:bg-background-dark transition-colors">
                    Cancelar
                </button>
                <button type="submit" :disabled="selectedPairs.length === 0 || isLoading" 
                        class="bg-primary hover:bg-orange-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg shadow-primary/30 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="material-symbols-outlined text-lg" x-show="!isLoading">search</span>
                    <span x-show="isLoading" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                    <span x-text="isLoading ? 'Buscando...' : 'Buscar'"></span>
                </button>
            </div>
        </div>
    </form>

    <!-- Results Area -->
    <div id="import-results" class="border-t border-slate-200 dark:border-border-dark">
        <!-- Loading Skeleton (visible while HTMX request is in flight) -->
        <template x-if="isLoading">
            <div class="p-6 space-y-4">
                <!-- Header skeleton -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                        <div class="space-y-2">
                            <div class="w-32 h-4 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                            <div class="w-48 h-3 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                        </div>
                    </div>
                    <div class="w-28 h-8 rounded-lg bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                </div>
                <!-- Tabs skeleton -->
                <div class="flex gap-2">
                    <div class="w-20 h-8 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                    <div class="w-24 h-8 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                    <div class="w-28 h-8 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                </div>
                <!-- Table skeleton rows -->
                <div class="rounded-xl border border-slate-200 dark:border-border-dark overflow-hidden">
                    <div class="bg-slate-50 dark:bg-slate-800 px-3 py-3">
                        <div class="flex gap-4">
                            <div class="w-8 h-4 rounded bg-slate-300 dark:bg-slate-600 animate-pulse"></div>
                            <div class="w-16 h-4 rounded bg-slate-300 dark:bg-slate-600 animate-pulse"></div>
                            <div class="w-24 h-4 rounded bg-slate-300 dark:bg-slate-600 animate-pulse"></div>
                            <div class="flex-1 h-4 rounded bg-slate-300 dark:bg-slate-600 animate-pulse"></div>
                            <div class="w-20 h-4 rounded bg-slate-300 dark:bg-slate-600 animate-pulse"></div>
                            <div class="w-16 h-4 rounded bg-slate-300 dark:bg-slate-600 animate-pulse"></div>
                        </div>
                    </div>
                    <div class="divide-y divide-slate-100 dark:divide-slate-700/50">
                        <template x-for="i in 6" :key="i">
                            <div class="px-3 py-3">
                                <div class="flex gap-4 items-center">
                                    <div class="w-4 h-4 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                                    <div class="w-8 h-4 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                                    <div class="w-20 h-4 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                                    <div class="flex-1 h-4 rounded bg-slate-200 dark:bg-slate-700 animate-pulse" :style="'animation-delay:' + (i * 100) + 'ms'"></div>
                                    <div class="w-24 h-4 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                                    <div class="w-16 h-4 rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                <!-- Status text -->
                <div class="flex items-center justify-center gap-3 py-4">
                    <span class="animate-spin h-5 w-5 border-2 border-primary border-t-transparent rounded-full"></span>
                    <span class="text-sm text-slate-500 dark:text-slate-400 font-medium">Consultando bases de dados externas...</span>
                </div>
            </div>
        </template>
    </div>
</div>

