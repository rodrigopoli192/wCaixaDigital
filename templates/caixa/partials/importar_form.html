<!-- Import Movements Modal Form -->
<script type="application/json" id="rotina-var-map">{{ rotina_variaveis|safe }}</script>
<div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto animate-scale-in"
     x-data="{ 
        selectedPairs: [],
        rotinaVarMap: {},
        paramValues: {},
        init() {
            // Load rotina variable map from script tag
            try {
                this.rotinaVarMap = JSON.parse(document.getElementById('rotina-var-map').textContent || '{}');
            } catch(e) { this.rotinaVarMap = {}; }
            // Load saved param values
            try {
                const saved = JSON.parse(localStorage.getItem('import_params') || '{}');
                this.paramValues = saved;
            } catch(e) { this.paramValues = {}; }
        },
        toggleConexao(conId, rotinaIds, checked) {
            if (checked) {
                rotinaIds.forEach(rId => {
                    const pair = conId + ':' + rId;
                    if (!this.selectedPairs.includes(pair)) this.selectedPairs.push(pair);
                });
            } else {
                this.selectedPairs = this.selectedPairs.filter(p => !p.startsWith(conId + ':'));
            }
        },
        toggleRotina(conId, rId, checked) {
            const pair = conId + ':' + rId;
            if (checked) {
                if (!this.selectedPairs.includes(pair)) this.selectedPairs.push(pair);
            } else {
                this.selectedPairs = this.selectedPairs.filter(p => p !== pair);
            }
        },
        isConexaoChecked(conId, rotinaIds) {
            return rotinaIds.every(rId => this.selectedPairs.includes(conId + ':' + rId));
        },
        isConexaoPartial(conId, rotinaIds) {
            const some = rotinaIds.some(rId => this.selectedPairs.includes(conId + ':' + rId));
            return some && !this.isConexaoChecked(conId, rotinaIds);
        },
        isRotinaChecked(conId, rId) {
            return this.selectedPairs.includes(conId + ':' + rId);
        },
        get activeVars() {
            const vars = new Set();
            this.selectedPairs.forEach(pair => {
                const rotinaId = pair.split(':')[1];
                (this.rotinaVarMap[rotinaId] || []).forEach(v => vars.add(v));
            });
            return [...vars].sort((a, b) => {
                const au = a.toUpperCase();
                const bu = b.toUpperCase();
                const aIsInicio = au.includes('INICIO') || au.includes('INITIAL');
                const bIsInicio = bu.includes('INICIO') || bu.includes('INITIAL');
                if (aIsInicio && !bIsInicio) return -1;
                if (!aIsInicio && bIsInicio) return 1;
                return a.localeCompare(b);
            });
        },
        isDateVar(name) {
            const n = name.toUpperCase();
            return n.includes('DATA') || n.includes('DATE');
        },
        salvarParams() {
            localStorage.setItem('import_params', JSON.stringify(this.paramValues));
        }
     }">
    
    <!-- Header -->
    <div class="px-6 py-4 border-b border-slate-200 dark:border-border-dark bg-slate-50 dark:bg-background-dark/50 flex items-center justify-between sticky top-0 z-10">
        <div>
            <h2 class="text-lg font-bold flex items-center gap-2 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined text-primary">cloud_download</span>
                Importar Movimentos
            </h2>
            <p class="text-xs text-slate-500 text-left">Buscar dados de sistemas externos via rotinas SQL</p>
        </div>
        <button type="button" @click="open = false" class="text-slate-400 hover:text-slate-600 dark:hover:text-white p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
            <span class="material-symbols-outlined">close</span>
        </button>
    </div>

    <!-- Form -->
    <form method="post"
          hx-post="{% url 'caixa:importar_movimentos' abertura.pk %}"
          hx-target="#import-results"
          hx-swap="innerHTML"
          hx-indicator="#import-spinner"
          @submit="salvarParams()"
          class="p-6 space-y-5">
        {% csrf_token %}

        <!-- Hidden inputs com os pares selecionados -->
        <template x-for="pair in selectedPairs" :key="pair">
            <input type="hidden" name="conexao_rotina_pairs" :value="pair">
        </template>

        <!-- Conexões + Rotinas (Árvore) -->
        <div class="space-y-1.5">
            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Conexões e Rotinas</label>
            
            {% if conexoes_tree %}
            <div class="space-y-2 max-h-[280px] overflow-y-auto custom-scrollbar pr-1">
                {% for item in conexoes_tree %}
                <div class="border border-slate-200 dark:border-border-dark rounded-lg overflow-hidden">
                    <!-- Conexão header -->
                    <label class="flex items-center gap-3 px-4 py-2.5 bg-slate-50 dark:bg-background-dark/50 cursor-pointer hover:bg-slate-100 dark:hover:bg-background-dark/70 transition-colors">
                        <input type="checkbox"
                               @change="toggleConexao('{{ item.conexao.pk }}', [{% for r in item.rotinas %}'{{ r.pk }}'{% if not forloop.last %},{% endif %}{% endfor %}], $event.target.checked)"
                               :checked="isConexaoChecked('{{ item.conexao.pk }}', [{% for r in item.rotinas %}'{{ r.pk }}'{% if not forloop.last %},{% endif %}{% endfor %}])"
                               :indeterminate="isConexaoPartial('{{ item.conexao.pk }}', [{% for r in item.rotinas %}'{{ r.pk }}'{% if not forloop.last %},{% endif %}{% endfor %}])"
                               class="w-4 h-4 text-primary rounded focus:ring-primary">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200">{{ item.conexao.sistema }}</span>
                    </label>
                    <!-- Rotinas -->
                    <div class="divide-y divide-slate-100 dark:divide-border-dark">
                        {% for rotina in item.rotinas %}
                        <label class="flex items-center gap-3 px-4 py-2 pl-10 cursor-pointer hover:bg-slate-50 dark:hover:bg-background-dark/30 transition-colors has-[:checked]:bg-primary/5">
                            <input type="checkbox"
                                   @change="toggleRotina('{{ item.conexao.pk }}', '{{ rotina.pk }}', $event.target.checked)"
                                   :checked="isRotinaChecked('{{ item.conexao.pk }}', '{{ rotina.pk }}')"
                                   class="w-3.5 h-3.5 text-primary rounded focus:ring-primary">
                            <div>
                                <span class="text-sm text-slate-600 dark:text-slate-300">{{ rotina.nome }}</span>
                                {% if rotina.descricao %}
                                <p class="text-[10px] text-slate-400 mt-0.5">{{ rotina.descricao }}</p>
                                {% endif %}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-slate-500 py-2">Nenhuma conexão externa configurada.</p>
            {% endif %}
        </div>

        <!-- Dynamic Parameters (auto-detected from SQL) -->
        <template x-if="activeVars.length > 0">
            <div class="space-y-3">
                <label class="text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm text-primary">tune</span>
                    Parâmetros da Rotina
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <template x-for="varName in activeVars" :key="varName">
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide" x-text="varName.replace(/_/g, ' ')"></label>
                            <template x-if="isDateVar(varName)">
                                <input :type="'date'" 
                                       :name="'param_' + varName" 
                                       x-model="paramValues[varName]"
                                       class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary text-slate-900 dark:text-white transition-all outline-none text-sm">
                            </template>
                            <template x-if="!isDateVar(varName)">
                                <input type="text" 
                                       :name="'param_' + varName" 
                                       x-model="paramValues[varName]"
                                       :placeholder="'@' + varName"
                                       class="w-full bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary text-slate-900 dark:text-white transition-all outline-none text-sm">
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Actions -->
        <div class="flex items-center justify-between pt-4 border-t border-slate-200 dark:border-border-dark">
            <span class="text-xs text-slate-500" x-show="selectedPairs.length > 0" x-text="selectedPairs.length + ' rotina(s) selecionada(s)'"></span>
            <span x-show="selectedPairs.length === 0"></span>
            <div class="flex items-center gap-3">
                <button type="button" @click="open = false" class="px-5 py-2.5 rounded-lg border border-slate-200 dark:border-border-dark text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-50 dark:hover:bg-background-dark transition-colors">
                    Cancelar
                </button>
                <button type="submit" :disabled="selectedPairs.length === 0" 
                        class="bg-primary hover:bg-orange-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg shadow-primary/30 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="material-symbols-outlined text-lg" id="import-spinner-icon">search</span>
                    <span class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full hidden" id="import-spinner"></span>
                    Buscar
                </button>
            </div>
        </div>
    </form>

    <!-- Results Area -->
    <div id="import-results" class="border-t border-slate-200 dark:border-border-dark"></div>
</div>
