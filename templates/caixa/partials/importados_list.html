<!-- Imported Movements List (Staging) - Card Layout with Per-Row Accordion -->
<!-- Supports partial payments: per-item valor input + status badges + session grouping -->
<div class="space-y-4" x-data="{ 
    selected: [], 
    selectAll: false,
    parcelas: {},
    toggleAll() { 
        this.selectAll = !this.selectAll;
        if (this.selectAll) {
            this.selected = {{ importados|length }} > 0 ? [{% for i in importados %}'{{ i.pk }}'{% if not forloop.last %},{% endif %}{% endfor %}] : [];
        } else {
            this.selected = [];
        }
    }
}">

    {% if importados %}
    <!-- Action Bar -->
    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-[#2B2C30] rounded-xl border border-slate-200 dark:border-[#2d3544]">
        <div class="flex items-center gap-3">
            <input type="checkbox" @click="toggleAll()" :checked="selectAll"
                   class="w-4 h-4 text-primary rounded focus:ring-primary">
            <span class="text-sm font-bold text-slate-500 dark:text-slate-400">
                <span x-text="selected.length" class="text-primary">0</span> de {{ importados|length }} selecionado(s)
            </span>
        </div>
        <div class="flex items-center gap-2">
            <!-- Confirm Button -->
            <form method="post" 
                  hx-post="{% url 'caixa:confirmar_importados' abertura.pk %}"
                  hx-swap="none"
                  x-show="selected.length > 0" x-transition
                  @submit="for(let id of selected){ let el=document.querySelector(`[data-parcela-id='${id}']`); if(el&&el.value){ let inp=document.createElement('input'); inp.type='hidden'; inp.name=`valor_parcela_${id}`; inp.value=el.value; $el.appendChild(inp); } }">
                {% csrf_token %}
                <template x-for="id in selected" :key="id">
                    <input type="hidden" name="importado_ids" :value="id">
                </template>
                
                <div class="flex items-center gap-2">
                    <select name="forma_pagamento_id" required
                            class="h-9 bg-white dark:bg-[#2B2C30] border border-slate-200 dark:border-[#2d3544] rounded-lg px-3 text-sm text-slate-700 dark:text-slate-200 focus:border-primary outline-none">
                        <option value="">Forma Pagto.</option>
                        {% for fp in formas_pagamento %}
                        <option value="{{ fp.pk }}">{{ fp.nome }}</option>
                        {% endfor %}
                    </select>
                    <select name="tipo" 
                            class="h-9 bg-white dark:bg-[#2B2C30] border border-slate-200 dark:border-[#2d3544] rounded-lg px-3 text-sm text-slate-700 dark:text-slate-200 focus:border-primary outline-none">
                        <option value="ENTRADA">Entrada</option>
                        <option value="SAIDA">Saída</option>
                    </select>
                    <button type="submit" class="h-9 bg-emerald-600 hover:bg-emerald-700 text-white px-4 rounded-lg text-sm font-bold flex items-center gap-1 transition-all">
                        <span class="material-symbols-outlined text-sm">check_circle</span>
                        Confirmar
                    </button>
                </div>
            </form>

            <!-- Delete Button -->
            <form method="post"
                  hx-post="{% url 'caixa:excluir_importados' abertura.pk %}"
                  hx-swap="none"
                  hx-confirm="Excluir os itens selecionados?"
                  x-show="selected.length > 0" x-transition>
                {% csrf_token %}
                <template x-for="id in selected" :key="id">
                    <input type="hidden" name="importado_ids" :value="id">
                </template>
                <button type="submit" class="h-9 bg-red-600/20 hover:bg-red-600/30 text-red-400 px-3 rounded-lg text-sm font-bold flex items-center gap-1 transition-all border border-red-600/30">
                    <span class="material-symbols-outlined text-sm">delete</span>
                    Excluir
                </button>
            </form>
        </div>
    </div>

    <!-- Pendentes de Sessões Anteriores -->
    {% if pendentes_anteriores %}
    <div class="space-y-2">
        <div class="flex items-center gap-2 px-1">
            <span class="material-symbols-outlined text-amber-500 text-lg">history</span>
            <h3 class="text-sm font-bold text-amber-600 dark:text-amber-400">Pendentes de Sessões Anteriores</h3>
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-600 dark:text-amber-400 font-bold">{{ pendentes_anteriores|length }}</span>
        </div>
        {% for imp in pendentes_anteriores %}
        {% include "caixa/partials/_movimento_card.html" with mov=imp show_checkbox=True show_tipo=False show_origem=True show_caixa=False model_type="importado" %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Importados Desta Sessão -->
    {% if importados_sessao_atual %}
    <div class="space-y-2">
        {% if pendentes_anteriores %}
        <div class="flex items-center gap-2 px-1">
            <span class="material-symbols-outlined text-primary text-lg">download</span>
            <h3 class="text-sm font-bold text-primary">Importados Desta Sessão</h3>
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-primary/20 text-primary font-bold">{{ importados_sessao_atual|length }}</span>
        </div>
        {% endif %}
        {% for imp in importados_sessao_atual %}
        {% include "caixa/partials/_movimento_card.html" with mov=imp show_checkbox=True show_tipo=False show_origem=True show_caixa=False model_type="importado" %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Fallback: all imports in single list (no session distinction) -->
    {% if not pendentes_anteriores and not importados_sessao_atual %}
    <div class="space-y-2">
        {% for imp in importados %}
        {% include "caixa/partials/_movimento_card.html" with mov=imp show_checkbox=True show_tipo=False show_origem=True show_caixa=False model_type="importado" %}
        {% endfor %}
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="flex flex-col items-center justify-center py-12 text-slate-500">
        <span class="material-symbols-outlined text-4xl opacity-30 mb-2">cloud_off</span>
        <p class="text-sm">Nenhum movimento importado pendente.</p>
    </div>
    {% endif %}
</div>
