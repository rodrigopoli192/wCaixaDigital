<!-- Imported Movements List (Staging) - Card Layout with Per-Row Accordion -->
<div class="space-y-4" x-data="{ 
    selected: [], 
    selectAll: false,
    toggleAll() { 
        this.selectAll = !this.selectAll;
        if (this.selectAll) {
            this.selected = {{ importados|length }} > 0 ? [{% for i in importados %}'{{ i.pk }}'{% if not forloop.last %},{% endif %}{% endfor %}] : [];
        } else {
            this.selected = [];
        }
    }
}">

    {% if importados %}
    <!-- Action Bar -->
    <div class="flex items-center justify-between p-4 bg-[#2B2C30] rounded-xl border border-[#2d3544]">
        <div class="flex items-center gap-3">
            <input type="checkbox" @click="toggleAll()" :checked="selectAll"
                   class="w-4 h-4 text-primary rounded focus:ring-primary">
            <span class="text-sm font-bold text-slate-400">
                <span x-text="selected.length" class="text-primary">0</span> de {{ importados|length }} selecionado(s)
            </span>
        </div>
        <div class="flex items-center gap-2">
            <!-- Confirm Button -->
            <form method="post" 
                  hx-post="{% url 'caixa:confirmar_importados' abertura.pk %}"
                  hx-swap="none"
                  x-show="selected.length > 0" x-transition>
                {% csrf_token %}
                <template x-for="id in selected" :key="id">
                    <input type="hidden" name="importado_ids" :value="id">
                </template>
                
                <div class="flex items-center gap-2">
                    <select name="forma_pagamento_id" required
                            class="h-9 bg-[#2B2C30] border border-[#2d3544] rounded-lg px-3 text-sm text-slate-200 focus:border-primary outline-none">
                        <option value="">Forma Pagto.</option>
                        {% for fp in formas_pagamento %}
                        <option value="{{ fp.pk }}">{{ fp.nome }}</option>
                        {% endfor %}
                    </select>
                    <select name="tipo" 
                            class="h-9 bg-[#2B2C30] border border-[#2d3544] rounded-lg px-3 text-sm text-slate-200 focus:border-primary outline-none">
                        <option value="ENTRADA">Entrada</option>
                        <option value="SAIDA">Saída</option>
                    </select>
                    <button type="submit" class="h-9 bg-emerald-600 hover:bg-emerald-700 text-white px-4 rounded-lg text-sm font-bold flex items-center gap-1 transition-all">
                        <span class="material-symbols-outlined text-sm">check_circle</span>
                        Confirmar
                    </button>
                </div>
            </form>

            <!-- Delete Button -->
            <form method="post"
                  hx-post="{% url 'caixa:excluir_importados' abertura.pk %}"
                  hx-swap="none"
                  hx-confirm="Excluir os itens selecionados?"
                  x-show="selected.length > 0" x-transition>
                {% csrf_token %}
                <template x-for="id in selected" :key="id">
                    <input type="hidden" name="importado_ids" :value="id">
                </template>
                <button type="submit" class="h-9 bg-red-600/20 hover:bg-red-600/30 text-red-400 px-3 rounded-lg text-sm font-bold flex items-center gap-1 transition-all border border-red-600/30">
                    <span class="material-symbols-outlined text-sm">delete</span>
                    Excluir
                </button>
            </form>
        </div>
    </div>

    <!-- Cards -->
    <div class="space-y-2">
        {% for imp in importados %}
        <div class="bg-[#2B2C30] rounded-xl border border-[#2d3544] overflow-hidden transition-colors"
             :class="selected.includes('{{ imp.pk }}') ? 'border-primary/50 bg-primary/5' : ''"
             x-data="{ details: false }">

            <!-- Main Row -->
            <div class="flex items-center gap-3 px-4 py-3">
                <!-- Checkbox -->
                <input type="checkbox" value="{{ imp.pk }}" x-model="selected"
                       class="w-4 h-4 text-primary rounded focus:ring-primary shrink-0">

                <!-- Info: two rows stacked -->
                <div class="flex-1 min-w-0 space-y-1">
                    <!-- Row 1: Protocolo | Descrição | Status | Emolumento | Taxas | Total | Badge -->
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-mono text-slate-200 shrink-0 w-[80px] truncate" title="{{ imp.protocolo }}">{{ imp.protocolo|default:"—" }}</span>
                        <span class="text-sm text-slate-300 truncate flex-1 min-w-0" title="{{ imp.descricao }}">{{ imp.descricao|default:"—" }}</span>
                        <!-- Status -->
                        <span class="text-[10px] px-2 py-0.5 rounded-full shrink-0
                            {% if imp.status_item == 'Aberto' or not imp.status_item %}bg-emerald-500/20 text-emerald-400
                            {% elif imp.status_item == 'Cancelado' %}bg-red-500/20 text-red-400
                            {% else %}bg-blue-500/20 text-blue-400{% endif %} font-bold">
                            {{ imp.status_item|default:"Aberto" }}
                        </span>
                        <!-- Values -->
                        <div class="flex items-center gap-3 shrink-0 text-right">
                            <div class="w-[90px]">
                                <span class="text-[9px] uppercase text-slate-500 block leading-none">Emolumento</span>
                                <span class="text-xs font-mono text-slate-200">R$ {{ imp.emolumento|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="w-[80px]">
                                <span class="text-[9px] uppercase text-slate-500 block leading-none">Taxas</span>
                                {% with fundos=imp.valor_total_fundos %}
                                <span class="text-xs font-mono {% if fundos %}text-blue-400{% else %}text-slate-500{% endif %}">R$ {{ fundos|floatformat:2 }}</span>
                                {% endwith %}
                            </div>
                            <div class="w-[90px]">
                                <span class="text-[9px] uppercase text-slate-500 block leading-none">Total</span>
                                {% with total=imp.valor_total_taxas %}
                                <span class="text-xs font-mono font-bold {% if total %}text-emerald-400{% else %}text-slate-500{% endif %}">R$ {{ total|floatformat:2 }}</span>
                                {% endwith %}
                            </div>
                        </div>
                        <!-- Origem badge -->
                        <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-700 text-slate-400 font-medium shrink-0 max-w-[180px] truncate" title="{{ imp.conexao.sistema|default:'—' }} - {{ imp.rotina.nome|default:'—' }}">{{ imp.conexao.sistema|default:"—" }} - {{ imp.rotina.nome|default:"—" }}</span>
                    </div>
                    <!-- Row 2: Apresentante (subtitle) -->
                    <div class="flex items-center gap-2 pl-0">
                        <span class="text-[10px] text-slate-500 truncate" title="{{ imp.cliente_nome }}">{% if imp.cliente_nome %}Apresentante: {{ imp.cliente_nome }}{% endif %}</span>
                    </div>
                </div>

                <!-- Expand Toggle -->
                <button @click="details = !details" class="shrink-0 p-1 rounded hover:bg-[#2d3544] transition-colors">
                    <span class="material-symbols-outlined text-slate-400 text-lg transition-transform" :class="details ? 'rotate-180' : ''">expand_more</span>
                </button>
            </div>

            <!-- Details Accordion -->
            <div x-show="details" x-collapse class="border-t border-[#2d3544]">
                <div class="px-5 py-4 space-y-3">
                    <!-- Row 1: Meta Info -->
                    <div class="flex items-center gap-6 text-xs">
                        <div>
                            <span class="text-slate-500">Status:</span>
                            <span class="text-slate-300 font-medium ml-1">{{ imp.status_item|default:"Aberto" }}</span>
                        </div>
                        <div>
                            <span class="text-slate-500">QTD:</span>
                            <span class="text-slate-300 font-medium ml-1">{{ imp.quantidade|default:"1" }}</span>
                        </div>
                        <div>
                            <span class="text-slate-500">Origem:</span>
                            <span class="text-slate-300 font-medium ml-1">{{ imp.conexao.sistema|default:"—" }} — {{ imp.rotina.nome|default:"—" }}</span>
                        </div>
                        <div>
                            <span class="text-slate-500">Importado em:</span>
                            <span class="text-slate-300 font-medium ml-1">{{ imp.importado_em|date:"d/m/Y H:i" }}</span>
                        </div>
                    </div>

                    <!-- Row 2: All Taxes Grid -->
                    <div>
                        <span class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-2">Taxas Detalhadas</span>
                        <div class="grid grid-cols-5 gap-x-6 gap-y-1.5">
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">Tx Judiciária</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.taxa_judiciaria|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">ISS</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.iss|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FUNDESP</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.fundesp|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FUNESP</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.funesp|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">Estado</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.estado|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FESEMPS</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.fesemps|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FUNEMP</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.funemp|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FUNCOMP</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.funcomp|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FEPADSAJ</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.fepadsaj|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FUNPROGE</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.funproge|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FUNDEPEG</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.fundepeg|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FUNDAF</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.fundaf|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FEMAL</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.femal|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">FECAD</span>
                                <span class="font-mono text-slate-300">R$ {{ imp.fecad|default:"0"|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500 font-bold">Emolumento</span>
                                <span class="font-mono font-bold text-primary">R$ {{ imp.emolumento|default:"0"|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="flex flex-col items-center justify-center py-12 text-slate-500">
        <span class="material-symbols-outlined text-4xl opacity-30 mb-2">cloud_off</span>
        <p class="text-sm">Nenhum movimento importado pendente.</p>
    </div>
    {% endif %}
</div>
