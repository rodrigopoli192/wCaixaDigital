{% extends "base_dark.html" %}
{% load static %}

{% block title %}Caixa {{ caixa.identificador }} - wCaixaDigital{% endblock %}

{% block content %}
<div class="p-6 w-full space-y-6" x-data="{ open: false }">
    <!-- Modal Container -->
    <div x-show="open" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- Backdrop -->
            <div x-show="open" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" @click="open = false"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <!-- Modal Panel -->
            <!-- Styles removed to allow partials to control their own size and appearance -->
            <div x-show="open" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                 class="inline-block align-bottom text-left overflow-hidden transform transition-all sm:my-8 sm:align-middle w-auto">
                <div id="modal-content">
                    <!-- Content injected via HTMX -->
                    <div class="flex justify-center p-4">
                        <span class="animate-spin h-6 w-6 text-emerald-500"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb & Header -->
    <div class="flex flex-col gap-4 md:flex-row md:items-end justify-between">
        <div class="space-y-1">
            <nav class="flex text-sm text-slate-500 dark:text-slate-400 mb-1">
                <a href="{% url 'caixa:list' %}" class="hover:text-primary transition-colors">Caixas</a>
                <span class="mx-2">/</span>
                <span class="text-slate-700 dark:text-slate-200 font-medium">{{ caixa.identificador }}</span>
            </nav>
            <div class="flex items-center gap-3">
                <h3 class="text-3xl font-bold tracking-tight">{{ caixa.identificador }}</h3>
                {% if caixa.status == 'ABERTO' %}
                    {% if abertura_atual and not abertura_atual.is_operacional_hoje %}
                    <span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-warning/10 text-warning border border-warning/20 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">warning</span>
                        Aberto Anteriormente
                    </span>
                    {% else %}
                    <span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-success/10 text-success border border-success/20 flex items-center gap-2">
                        <span class="size-2 rounded-full bg-success animate-pulse"></span>
                        Aberto
                    </span>
                    {% endif %}
                {% elif caixa.status == 'FECHADO' %}
                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-slate-100 text-slate-500 border border-slate-200">
                    Fechado
                </span>
                {% elif caixa.status == 'BLOQUEADO' %}
                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-danger/10 text-danger border border-danger/20">
                    Bloqueado
                </span>
                {% endif %}
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm">{{ caixa.get_tipo_display }} • Criado em {{ caixa.created_at|date:"d/m/Y" }}</p>
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap gap-2">
            {% if caixa.status == 'FECHADO' %}
            <a href="#" 
               hx-get="{% url 'caixa:abrir' caixa.pk %}"
               hx-target="#modal-content"
               hx-trigger="click"
               hx-swap="innerHTML"
               @click.prevent="open = true"
               class="bg-success hover:bg-emerald-600 text-white rounded-lg px-4 py-2 text-sm font-semibold flex items-center gap-2 transition-all shadow-lg shadow-success/20">
                <span class="material-symbols-outlined text-sm">login</span>
                Abrir Caixa
            </a>
            {% elif abertura_atual %}
            {% if abertura_atual.is_operacional_hoje %}
            <a href="#" 
               hx-get="{% url 'caixa:novo_movimento' abertura_atual.pk %}"
               hx-target="#modal-content"
               hx-trigger="click"
               hx-swap="innerHTML"
               @click.prevent="open = true"
               class="bg-primary hover:bg-orange-600 text-white rounded-lg px-4 py-2 text-sm font-semibold flex items-center gap-2 transition-all shadow-lg shadow-primary/20">
                <span class="material-symbols-outlined text-sm">add_circle</span>
                Novo Movimento
            </a>
            {% else %}
            <div class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-background-dark border border-slate-200 dark:border-border-dark flex items-center gap-2 opacity-75 cursor-not-allowed" title="Caixa aberto em data anterior">
                 <span class="material-symbols-outlined text-sm text-warning">lock_clock</span>
                 <span class="text-sm font-bold text-slate-500">Bloqueado p/ Lançamentos</span>
            </div>
            {% endif %}
            <a href="#" class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-background-dark/50 rounded-lg px-4 py-2 text-sm font-semibold flex items-center gap-2 transition-all"
               hx-get="{% url 'caixa:fechar' caixa.pk %}"
               hx-target="#modal-content"
               hx-trigger="click"
               hx-swap="innerHTML"
               @click.prevent="open = true">
                <span class="material-symbols-outlined text-sm text-danger">logout</span>
                Fechar Caixa
            </a>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Info Card -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white dark:bg-surface-dark p-6 rounded-xl border border-slate-200 dark:border-border-dark shadow-sm h-full">
                <h4 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">info</span>
                    Informações
                </h4>
                
                <div class="space-y-4">
                    <div class="p-4 rounded-lg bg-slate-50 dark:bg-background-dark/50 border border-slate-100 dark:border-border-dark">
                        <span class="text-xs font-bold uppercase text-slate-400 block mb-1">Saldo Atual</span>
                        <div class="text-2xl font-bold text-primary">R$ {{ caixa.saldo_atual|floatformat:2 }}</div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-border-dark">
                            <span class="text-sm text-slate-500">Operador Atual</span>
                            <span class="text-sm font-medium">
                                {% if caixa.operador_atual %}
                                <div class="flex items-center gap-2">
                                    <span class="size-6 rounded-full bg-primary/20 text-primary text-[10px] flex items-center justify-center font-bold">
                                        {{ caixa.operador_atual.first_name|slice:":1"|default:"U" }}
                                    </span>
                                    {{ caixa.operador_atual.get_full_name|default:caixa.operador_atual.username }}
                                </div>
                                {% else %}
                                <span class="italic text-slate-400">---</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-border-dark">
                            <span class="text-sm text-slate-500">Tipo</span>
                            <span class="text-sm font-medium">{{ caixa.get_tipo_display }}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-border-dark">
                            <span class="text-sm text-slate-500">Tenant</span>
                            <span class="text-sm font-medium text-slate-400">{{ caixa.tenant.nome_fantasia|default:"Principal" }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Abertura Atual -->
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white dark:bg-surface-dark p-6 rounded-xl border border-slate-200 dark:border-border-dark shadow-sm h-full flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <h4 class="font-bold text-lg flex items-center gap-2">
                        <span class="material-symbols-outlined text-success">restart_alt</span>
                        Abertura Atual
                    </h4>
                    {% if abertura_atual %}
                    <a href="{% url 'caixa:lista_movimentos' abertura_atual.pk %}" class="text-sm text-primary hover:underline font-medium">
                        Ver Movimentos →
                    </a>
                    {% endif %}
                </div>

                {% if abertura_atual %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div class="p-4 rounded-lg bg-slate-50 dark:bg-background-dark/50 space-y-1">
                            <span class="text-xs text-slate-500 uppercase font-bold">Iniciado em</span>
                            <div class="text-sm font-mono text-slate-700 dark:text-slate-200">
                                {{ abertura_atual.data_hora|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                        <div class="p-4 rounded-lg bg-slate-50 dark:bg-background-dark/50 space-y-1">
                            <span class="text-xs text-slate-500 uppercase font-bold">Saldo de Abertura</span>
                            <div class="text-sm font-mono font-bold text-slate-700 dark:text-slate-200">
                                R$ {{ abertura_atual.saldo_abertura|floatformat:2 }}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-auto">
                        <div class="p-4 rounded-xl border border-slate-100 dark:border-border-dark text-center">
                            <p class="text-xs text-slate-500 mb-1">Entradas</p>
                            <p class="text-lg font-bold text-success">
                                <span class="material-symbols-outlined align-middle text-sm">arrow_upward</span>
                                <!-- Simulado: Idealmente o model AberturaCaixa teria metodo para somar entradas -->
                                R$ {{ abertura_atual.saldo_movimentos|floatformat:2 }}
                            </p>
                        </div>
                        <div class="p-4 rounded-xl border border-slate-100 dark:border-border-dark text-center">
                            <p class="text-xs text-slate-500 mb-1">Saídas</p>
                            <p class="text-lg font-bold text-danger">
                                <span class="material-symbols-outlined align-middle text-sm">arrow_downward</span>
                                R$ 0,00 <!-- Placeholder/TODO -->
                            </p>
                        </div>
                         <div class="p-4 rounded-xl bg-primary/5 border border-primary/10 text-center">
                            <p class="text-xs text-primary mb-1 font-bold">Saldo Operacional</p>
                            <p class="text-xl font-bold text-primary">
                                R$ {{ abertura_atual.saldo_movimentos|floatformat:2 }}
                            </p>
                        </div>
                    </div>

                    {% if abertura_atual.observacao %}
                    <div class="mt-6 p-3 rounded-lg bg-warning/5 border border-warning/10 text-xs text-warning-dark flex gap-2">
                        <span class="material-symbols-outlined text-sm">sticky_note_2</span>
                        <p>{{ abertura_atual.observacao }}</p>
                    </div>
                    {% endif %}

                {% else %}
                    <div class="flex flex-col items-center justify-center flex-1 py-12 text-slate-400">
                        <div class="size-16 rounded-full bg-slate-50 dark:bg-background-dark flex items-center justify-center mb-4">
                            <span class="material-symbols-outlined text-3xl">lock_clock</span>
                        </div>
                        <p class="font-medium text-slate-600 dark:text-slate-300">Nenhuma abertura ativa</p>
                        <p class="text-sm">O caixa está fechado no momento.</p>
                        <a href="#" 
                           hx-get="{% url 'caixa:abrir' caixa.pk %}"
                           hx-target="#modal-content"
                           hx-trigger="click"
                           hx-swap="innerHTML"
                           @click.prevent="open = true"
                           class="mt-4 px-4 py-2 bg-success text-white rounded-lg text-sm font-bold hover:bg-emerald-600 transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">lock_open</span>
                            Realizar Abertura
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>


    <!-- Histórico de Aberturas -->
    <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-sm overflow-hidden w-full">
        <div class="p-6 border-b border-slate-200 dark:border-border-dark">
            <h4 class="font-bold text-lg">Histórico Recente</h4>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-slate-50 dark:bg-background-dark/50 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">
                        <th class="px-6 py-4">Data Abertura</th>
                        <th class="px-6 py-4">Data Fechamento</th>
                        <th class="px-6 py-4">Operador</th>
                        <th class="px-6 py-4 text-right">Saldo Inicial</th>
                        <th class="px-6 py-4 text-right">Saldo Final</th>
                         <th class="px-6 py-4 text-center">Status</th>
                         <th class="px-6 py-4"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 dark:divide-border-dark">
                    {% for abertura in ultimas_aberturas %}
                    <tr class="hover:bg-slate-50/50 dark:hover:bg-background-dark/30 transition-colors">
                        <td class="px-6 py-4 font-mono text-sm text-slate-600 dark:text-slate-300">
                            {{ abertura.data_hora|date:"d/m/Y H:i" }}
                        </td>
                         <td class="px-6 py-4 font-mono text-sm text-slate-500 dark:text-slate-400">
                            {{ abertura.fechamento.data_hora|date:"d/m/Y H:i"|default:"-" }}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="size-6 rounded-full bg-slate-100 dark:bg-background-dark text-slate-500 text-[10px] flex items-center justify-center font-bold">
                                    {{ abertura.operador.first_name|slice:":1"|default:"U" }}
                                </span>
                                {{ abertura.operador.first_name|default:abertura.operador.username }}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right text-sm text-slate-600 dark:text-slate-300">
                            R$ {{ abertura.saldo_abertura|floatformat:2 }}
                        </td>
                         <td class="px-6 py-4 text-right text-sm font-bold text-slate-700 dark:text-slate-200">
                            R$ {{ abertura.saldo_movimentos|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 text-center">
                            {% if abertura.fechado %}
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-slate-100 text-slate-500 border border-slate-200">Fechado</span>
                            {% else %}
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-success/10 text-success border border-success/20 animate-pulse">Ativo</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <a href="{% url 'caixa:lista_movimentos' abertura.pk %}" class="p-1 rounded text-slate-400 hover:text-primary transition-colors" title="Ver Movimentos">
                                <span class="material-symbols-outlined text-lg">receipt_long</span>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-sm text-slate-500">
                            Nenhum histórico de abertura registrado.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
