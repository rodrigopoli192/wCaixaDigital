============================= test session starts =============================
platform win32 -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0
django: version: 5.2.11, settings: caixa_nfse.settings.local (from env)
rootdir: C:\Users\Rodrigo\Projetos\wCaixaDigital
configfile: pytest.ini (WARNING: ignoring pytest config in pyproject.toml!)
plugins: anyio-4.12.1, Faker-40.1.2, asyncio-1.3.0, cov-7.0.0, django-4.11.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 18 items

caixa_nfse\nfse\tests\test_xml_builder.py ..FF.FF.F.FFFF.F.F             [100%]

================================== FAILURES ===================================
_________________ TestXmlBuilder.test_identificacao_presente __________________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A82E9CD0>

    def test_identificacao_presente(self):
        """Grupo de identificaþÒo deve conter campos obrigat¾rios."""
        nota = NotaFiscalServicoFactory()
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        ident = inf.find(f"{NS}Id")
>       assert ident is not None
E       assert None is not None

caixa_nfse\nfse\tests\test_xml_builder.py:39: AssertionError
___________________ TestXmlBuilder.test_prestador_presente ____________________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A82E9F30>

    def test_prestador_presente(self):
        """Dados do prestador devem incluir CNPJ e razÒo social."""
        nota = NotaFiscalServicoFactory()
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        prest = inf.find(f"{NS}prest")
        assert prest is not None
        assert prest.find(f"{NS}CNPJ") is not None
>       assert prest.find(f"{NS}xNome") is not None
E       AssertionError: assert None is not None
E        +  where None = find('{http://www.sped.fazenda.gov.br/nfse}xNome')
E        +    where find = <Element {http://www.sped.fazenda.gov.br/nfse}prest at 0x1c4abfc0900>.find

caixa_nfse\nfse\tests\test_xml_builder.py:54: AssertionError
____________________ TestXmlBuilder.test_servico_presente _____________________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A82EE030>

    def test_servico_presente(self):
        """Grupo de serviþo deve incluir c¾digo e descriþÒo."""
        nota = NotaFiscalServicoFactory()
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        serv = inf.find(f"{NS}serv")
        assert serv is not None
        assert serv.find(f"{NS}cServ") is not None
>       assert serv.find(f"{NS}xDescServ") is not None
E       AssertionError: assert None is not None
E        +  where None = find('{http://www.sped.fazenda.gov.br/nfse}xDescServ')
E        +    where find = <Element {http://www.sped.fazenda.gov.br/nfse}serv at 0x1c4abed43c0>.find

caixa_nfse\nfse\tests\test_xml_builder.py:77: AssertionError
____________________ TestXmlBuilder.test_valores_presente _____________________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A82EE250>

    def test_valores_presente(self):
        """Grupo de valores deve incluir vServPrest, vBC, vISS e vLiq."""
        nota = NotaFiscalServicoFactory()
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        vals = inf.find(f"{NS}valores")
        assert vals is not None
>       assert vals.find(f"{NS}vServPrest").text == "100.00"
E       AssertionError: assert None == '100.00'
E        +  where None = <Element {http://www.sped.fazenda.gov.br/nfse}vServPrest at 0x1c4abefa840>.text
E        +    where <Element {http://www.sped.fazenda.gov.br/nfse}vServPrest at 0x1c4abefa840> = find('{http://www.sped.fazenda.gov.br/nfse}vServPrest')
E        +      where find = <Element {http://www.sped.fazenda.gov.br/nfse}valores at 0x1c4abefad40>.find

caixa_nfse\nfse\tests\test_xml_builder.py:86: AssertionError
___________ TestXmlBuilder.test_ibs_cbs_presente_quando_preenchido ____________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A82D2350>

    def test_ibs_cbs_presente_quando_preenchido(self):
        """Grupo IBSCBS deve aparecer quando CBS ou IBS > 0."""
        from decimal import Decimal
    
        nota = NotaFiscalServicoFactory(valor_cbs=Decimal("5.00"), valor_ibs=Decimal("3.00"))
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        grupo = inf.find(f"{NS}IBSCBS")
>       assert grupo is not None
E       assert None is not None

caixa_nfse\nfse\tests\test_xml_builder.py:106: AssertionError
__________________ TestXmlBuilder.test_gerar_id_dps_formato ___________________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A82135C0>

    def test_gerar_id_dps_formato(self):
        """ID da DPS deve seguir o formato: DPS + CNPJ(14) + sÚrie(5) + n·mero(15)."""
        tenant = TenantFactory(cnpj="12345678000100")
        nota = NotaFiscalServicoFactory(tenant=tenant, numero_rps=42, serie_rps="1")
        id_dps = _gerar_id_dps(nota, tenant)
        assert id_dps.startswith("DPS")
        assert "12345678000100" in id_dps
        # Total: 3 + 14 + 5 + 15 = 37 chars
>       assert len(id_dps) == 37
E       AssertionError: assert 45 == 37
E        +  where 45 = len('DPS355030821234567800010000001000000000000042')

caixa_nfse\nfse\tests\test_xml_builder.py:127: AssertionError
____________________ TestXmlBuilder.test_ambiente_producao ____________________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A83319B0>

    def test_ambiente_producao(self):
        """tpAmb deve ser '1' para produþÒo."""
        nota = NotaFiscalServicoFactory(ambiente="PRODUCAO")
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        ident = inf.find(f"{NS}Id")
>       tp_amb = ident.find(f"{NS}tpAmb")
                 ^^^^^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'find'

caixa_nfse\nfse\tests\test_xml_builder.py:135: AttributeError
__________________ TestXmlBuilder.test_ambiente_homologacao ___________________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A8331E10>

    def test_ambiente_homologacao(self):
        """tpAmb deve ser '2' para homologaþÒo."""
        nota = NotaFiscalServicoFactory(ambiente="HOMOLOGACAO")
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        ident = inf.find(f"{NS}Id")
>       tp_amb = ident.find(f"{NS}tpAmb")
                 ^^^^^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'find'

caixa_nfse\nfse\tests\test_xml_builder.py:144: AttributeError
___________________ TestXmlBuilder.test_endereco_prestador ____________________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A831C390>

    def test_endereco_prestador(self):
        """Endereþo do prestador deve estar presente."""
        nota = NotaFiscalServicoFactory()
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        prest = inf.find(f"{NS}prest")
        end = prest.find(f"{NS}end")
>       assert end is not None
E       assert None is not None

caixa_nfse\nfse\tests\test_xml_builder.py:154: AssertionError
_____________________ TestXmlBuilder.test_iss_retido_flag _____________________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A827A2D0>

    def test_iss_retido_flag(self):
        """Flag ISS retido deve mapear para tpRetISS = '1'."""
        nota = NotaFiscalServicoFactory(iss_retido=True)
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        vals = inf.find(f"{NS}valores")
>       assert vals.find(f"{NS}tpRetISS").text == "1"
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'text'

caixa_nfse\nfse\tests\test_xml_builder.py:173: AttributeError
___________ TestXmlBuilder.test_retencoes_federais_todas_presentes ____________

self = <caixa_nfse.nfse.tests.test_xml_builder.TestXmlBuilder object at 0x000001C4A8338E10>

    def test_retencoes_federais_todas_presentes(self):
        """Todas as retenþ§es federais devem aparecer quando preenchidas."""
        from decimal import Decimal
    
        nota = NotaFiscalServicoFactory(
            valor_pis=Decimal("1.50"),
            valor_cofins=Decimal("2.50"),
            valor_inss=Decimal("3.00"),
            valor_ir=Decimal("4.00"),
            valor_csll=Decimal("1.00"),
        )
        dps = construir_dps(nota, nota.tenant)
        inf = dps.find(f"{NS}infDPS")
        vals = inf.find(f"{NS}valores")
    
>       assert vals.find(f"{NS}vPIS").text == "1.50"
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'text'

caixa_nfse\nfse\tests\test_xml_builder.py:202: AttributeError
=========================== short test summary info ===========================
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_identificacao_presente
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_prestador_presente
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_servico_presente
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_valores_presente
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_ibs_cbs_presente_quando_preenchido
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_gerar_id_dps_formato
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_ambiente_producao
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_ambiente_homologacao
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_endereco_prestador
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_iss_retido_flag
FAILED caixa_nfse/nfse/tests/test_xml_builder.py::TestXmlBuilder::test_retencoes_federais_todas_presentes
======================== 11 failed, 7 passed in 2.24s =========================
